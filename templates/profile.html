<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=0.9">
    <meta name="robots" content="noindex">
    <title>Profile Settings - {{ content.title.content | default("EDGI Datasette Cloud Portal") }}</title>
    <script src="https://cdn.tailwindcss.com/3.4.16"></script>
    <script src="/static/js/tailwind.config.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/remixicon/4.6.0/remixicon.min.css">
    <link rel="stylesheet" href="/static/styles.css">
    <link rel="icon" href="/static/favicon.ico">
</head>
<body class="bg-background">
    <header class="fixed top-0 left-0 right-0 z-50 bg-header text-white shadow-md">
        <div class="container mx-auto px-4 h-20 flex items-center justify-between">
            <div class="flex items-center">
                <div class="w-10 h-10 flex items-center justify-center mr-3">
                    <i class="ri-user-settings-line text-white ri-2x" aria-hidden="true"></i>
                </div>
                <div class="text-xl font-semibold">Profile Settings</div>
            </div>
            {% if actor %}
                <div>
                    {% if actor.role == "system_admin" %}
                        <a href="/system-admin" class="text-white hover:text-accent mr-4">Admin Panel</a>
                    {% endif %}
                    <a href="/manage-databases" class="text-white hover:text-accent mr-4">My Databases</a>
                    <a href="/logout" class="text-white hover:text-accent">Logout</a>
                </div>
            {% endif %}
        </div>
    </header>
    
    <main class="flex-grow pt-20 pb-6">
        <section class="container mx-auto px-4 mt-6">
            <div class="w-[80%] mx-auto">
                <!-- Header with User Info -->
                <div class="flex items-center justify-between mb-6 mt-1">
                    <div>
                        <h1 class="text-3xl font-bold text-primary">Profile Settings</h1>
                        <p class="text-textlight mt-2">Manage your account information and preferences</p>
                    </div>
                    <div class="flex items-center space-x-4">
                        <div class="w-12 h-12 bg-accent rounded-full flex items-center justify-center">
                            <i class="ri-user-line text-white ri-xl"></i>
                        </div>
                        <div>
                            <div class="font-semibold text-text">{{ user.username }}</div>
                            <div class="text-sm text-textlight">{{ user.role.replace('_', ' ').title() }}</div>
                        </div>
                    </div>
                </div>

                <!-- Success/Error Messages -->
                {% if success %}
                    <div class="bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded mb-6">
                        <p class="text-sm">{{ success }}</p>
                    </div>
                {% endif %}
                {% if error %}
                    <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-6">
                        <p class="text-sm">{{ error }}</p>
                    </div>
                {% endif %}

                <!-- Statistics Cards -->
                <div class="mt-8 grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                    <div class="bg-card rounded-card p-4 border border-border text-center">
                        <div class="text-2xl font-bold text-accent">{{ stats.user_databases | default(0) }}</div>
                        <div class="text-textlight text-sm">Active Databases</div>
                    </div>
                    <div class="bg-card rounded-card p-4 border border-border text-center">
                        <div class="text-2xl font-bold text-green-500">{{ stats.user_published | default(0) }}</div>
                        <div class="text-textlight text-sm">Published</div>
                    </div>
                    <div class="bg-card rounded-card p-4 border border-border text-center">
                        <div class="text-2xl font-bold text-orange-500">{{ stats.user_trashed | default(0) }}</div>
                        <div class="text-textlight text-sm">In Trash</div>
                    </div>
                    <div class="bg-card rounded-card p-4 border border-border text-center">
                        <a href="/manage-databases" class="block hover:bg-gray-50 transition rounded p-2">
                            <div class="text-2xl font-bold text-blue-500">
                                <i class="ri-database-2-line"></i>
                            </div>
                            <div class="text-textlight text-sm">Manage Databases</div>
                        </a>
                    </div>
                </div>

                <!-- Main Content Grid -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <!-- Account Information -->
                    <div class="bg-card rounded-card border border-border p-6">
                        <h3 class="text-xl font-semibold text-primary mb-6 flex items-center">
                            <i class="ri-information-line mr-2"></i>Account Information
                        </h3>
                        
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-text mb-1">Username</label>
                                <div class="p-3 bg-gray-50 border border-border rounded-button text-textlight">
                                    {{ user.username }}
                                </div>
                                <p class="text-xs text-textlight mt-1">Username cannot be changed</p>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-text mb-1">Role</label>
                                <div class="p-3 bg-gray-50 border border-border rounded-button">
                                    <span class="px-2 py-1 rounded-full text-xs font-medium 
                                        {% if user.role == 'system_admin' %}bg-red-100 text-red-800{% else %}bg-blue-100 text-blue-800{% endif %}">
                                        {{ user.role.replace('_', ' ').title() }}
                                    </span>
                                </div>
                                <p class="text-xs text-textlight mt-1">Role can only be changed by administrators</p>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-text mb-1">Member Since</label>
                                <div class="p-3 bg-gray-50 border border-border rounded-button text-textlight">
                                    {{ user.created_at[:10] if user.created_at else 'N/A' }}
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Update Email -->
                    <div class="bg-card rounded-card border border-border p-6">
                        <h3 class="text-xl font-semibold text-primary mb-6 flex items-center">
                            <i class="ri-mail-line mr-2"></i>Email Address
                        </h3>
                        
                        <form method="post" class="space-y-4">
                            <input type="hidden" name="csrftoken" value="{{ csrftoken() }}">
                            <input type="hidden" name="action" value="update_email">
                            
                            <div>
                                <label for="current_email" class="block text-sm font-medium text-text mb-1">Current Email</label>
                                <div class="p-3 bg-gray-50 border border-border rounded-button text-textlight">
                                    {{ user.email }}
                                </div>
                            </div>
                            
                            <div>
                                <label for="new_email" class="block text-sm font-medium text-text mb-2">New Email Address</label>
                                <input type="email" 
                                       id="new_email" 
                                       name="new_email" 
                                       class="w-full p-3 border border-border rounded-button focus:outline-none focus:ring-2 focus:ring-accent focus:border-accent"
                                       placeholder="Enter new email address">
                            </div>
                            
                            <button type="submit" 
                                    class="w-full bg-blue-500 text-white py-3 px-4 rounded-button hover:bg-blue-600 transition font-medium">
                                <i class="ri-save-line mr-2"></i>Update Email
                            </button>
                        </form>
                    </div>

                    <!-- Change Password -->
                    <div class="bg-card rounded-card border border-border p-6">
                        <h3 class="text-xl font-semibold text-primary mb-6 flex items-center">
                            <i class="ri-lock-password-line mr-2"></i>Change Password
                        </h3>
                        
                        <form method="post" class="space-y-4">
                            <input type="hidden" name="csrftoken" value="{{ csrftoken() }}">
                            <input type="hidden" name="action" value="change_password">
                            
                            <div>
                                <label for="current_password" class="block text-sm font-medium text-text mb-2">Current Password</label>
                                <div class="relative">
                                    <input type="password" 
                                           id="current_password" 
                                           name="current_password" 
                                           required 
                                           class="w-full p-3 border border-border rounded-button focus:outline-none focus:ring-2 focus:ring-accent focus:border-accent pr-12"
                                           placeholder="Enter current password">
                                    <button type="button" 
                                            onclick="togglePassword('current_password')" 
                                            class="absolute right-3 top-1/2 transform -translate-y-1/2 text-textlight hover:text-accent">
                                        <i class="ri-eye-off-line"></i>
                                    </button>
                                </div>
                            </div>
                            
                            <div>
                                <label for="new_password" class="block text-sm font-medium text-text mb-2">New Password</label>
                                <div class="relative">
                                    <input type="password" 
                                           id="new_password" 
                                           name="new_password" 
                                           required 
                                           class="w-full p-3 border border-border rounded-button focus:outline-none focus:ring-2 focus:ring-accent focus:border-accent pr-12"
                                           placeholder="Enter new password">
                                    <button type="button" 
                                            onclick="togglePassword('new_password')" 
                                            class="absolute right-3 top-1/2 transform -translate-y-1/2 text-textlight hover:text-accent">
                                        <i class="ri-eye-off-line"></i>
                                    </button>
                                </div>
                            </div>
                            
                            <div>
                                <label for="confirm_password" class="block text-sm font-medium text-text mb-2">Confirm New Password</label>
                                <div class="relative">
                                    <input type="password" 
                                           id="confirm_password" 
                                           name="confirm_password" 
                                           required 
                                           class="w-full p-3 border border-border rounded-button focus:outline-none focus:ring-2 focus:ring-accent focus:border-accent pr-12"
                                           placeholder="Confirm new password">
                                    <button type="button" 
                                            onclick="togglePassword('confirm_password')" 
                                            class="absolute right-3 top-1/2 transform -translate-y-1/2 text-textlight hover:text-accent">
                                        <i class="ri-eye-off-line"></i>
                                    </button>
                                </div>
                            </div>
                            
                            <button type="submit" 
                                    class="w-full bg-accent text-white py-3 px-4 rounded-button hover:bg-primary transition font-medium">
                                <i class="ri-key-line mr-2"></i>Change Password
                            </button>
                        </form>
                        
                        <div class="mt-4 p-3 bg-blue-50 border border-blue-200 rounded">
                            <h4 class="text-sm font-medium text-blue-800 mb-2">Password Requirements</h4>
                            <ul class="text-blue-700 text-xs space-y-1">
                                <li>• At least 6 characters long</li>
                                <li>• Mix of letters, numbers, and symbols recommended</li>
                                <li>• Avoid using common words or personal information</li>
                            </ul>
                        </div>
                    </div>

                    <!-- Quick Actions -->
                    <div class="bg-card rounded-card border border-border p-6">
                        <h3 class="text-xl font-semibold text-primary mb-6 flex items-center">
                            <i class="ri-links-line mr-2"></i>Quick Actions
                        </h3>
                        
                        <div class="space-y-3">
                            <a href="/manage-databases" class="flex items-center justify-between p-3 bg-gray-50 rounded hover:bg-gray-100 transition">
                                <div class="flex items-center">
                                    <i class="ri-database-line mr-3 text-accent"></i>
                                    <span class="font-medium text-text">Manage My Databases</span>
                                </div>
                                <i class="ri-arrow-right-s-line text-textlight"></i>
                            </a>
                            
                            <a href="/create-database" class="flex items-center justify-between p-3 bg-gray-50 rounded hover:bg-gray-100 transition">
                                <div class="flex items-center">
                                    <i class="ri-add-circle-line mr-3 text-green-600"></i>
                                    <span class="font-medium text-text">Create New Database</span>
                                </div>
                                <i class="ri-arrow-right-s-line text-textlight"></i>
                            </a>
                            
                            {% if stats.user_trashed > 0 %}
                            <a href="/manage-databases?status=trash" class="flex items-center justify-between p-3 bg-gray-50 rounded hover:bg-gray-100 transition">
                                <div class="flex items-center">
                                    <i class="ri-delete-bin-line mr-3 text-orange-600"></i>
                                    <span class="font-medium text-text">View Trash Bin ({{ stats.user_trashed }})</span>
                                </div>
                                <i class="ri-arrow-right-s-line text-textlight"></i>
                            </a>
                            {% endif %}
                            
                            <a href="/all-databases" class="flex items-center justify-between p-3 bg-gray-50 rounded hover:bg-gray-100 transition">
                                <div class="flex items-center">
                                    <i class="ri-global-line mr-3 text-blue-600"></i>
                                    <span class="font-medium text-text">Browse All Public Databases</span>
                                </div>
                                <i class="ri-arrow-right-s-line text-textlight"></i>
                            </a>
                        </div>
                    </div>
                </div>

                <!-- Danger Zone -->
                <div class="mt-8 bg-red-50 border border-red-200 rounded-card p-6">
                    <h3 class="text-xl font-semibold text-red-800 mb-4 flex items-center">
                        <i class="ri-error-warning-line mr-2"></i>Danger Zone
                    </h3>
                    
                    <div class="space-y-4">
                        <div class="flex items-center justify-between p-4 border border-red-200 rounded">
                            <div>
                                <h4 class="font-medium text-red-800">Reset Account</h4>
                                <p class="text-red-600 text-sm">Clear all your databases and start fresh</p>
                            </div>
                            <button onclick="showResetConfirm()" 
                                    class="bg-red-100 text-red-800 px-4 py-2 rounded hover:bg-red-200 transition text-sm font-medium">
                                Reset Account
                            </button>
                        </div>
                        
                        {% if user.role != 'system_admin' %}
                        <div class="flex items-center justify-between p-4 border border-red-200 rounded">
                            <div>
                                <h4 class="font-medium text-red-800">Delete Account</h4>
                                <p class="text-red-600 text-sm">Permanently delete your account and all data</p>
                            </div>
                            <button onclick="showDeleteConfirm()" 
                                    class="bg-red-600 text-white px-4 py-2 rounded hover:bg-red-700 transition text-sm font-medium">
                                Delete Account
                            </button>
                        </div>
                        {% else %}
                        <div class="flex items-center justify-between p-4 border border-red-200 rounded opacity-50">
                            <div>
                                <h4 class="font-medium text-red-800">Delete Account</h4>
                                <p class="text-red-600 text-sm">System administrators cannot delete their own accounts</p>
                            </div>
                            <button disabled 
                                    class="bg-gray-400 text-white px-4 py-2 rounded cursor-not-allowed text-sm font-medium">
                                Delete Account
                            </button>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </section>
    </main>

    <!-- Reset Confirmation Modal -->
    <div id="reset-confirm-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-white rounded-lg max-w-md w-full p-6">
                <h3 class="text-lg font-semibold mb-4 text-red-800">Reset Account Confirmation</h3>
                <p class="text-gray-600 mb-4">
                    This will permanently delete all your databases and uploaded data. 
                    This action cannot be undone.
                </p>
                <div class="flex gap-3">
                    <button onclick="resetAccount()" class="bg-red-600 text-white px-4 py-2 rounded hover:bg-red-700 transition">
                        Reset Account
                    </button>
                    <button onclick="closeResetModal()" class="bg-gray-300 text-gray-700 px-4 py-2 rounded hover:bg-gray-400 transition">
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div id="delete-confirm-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-white rounded-lg max-w-md w-full p-6">
                <h3 class="text-lg font-semibold mb-4 text-red-800">Delete Account Confirmation</h3>
                <p class="text-gray-600 mb-4">
                    This will permanently delete your account, all your databases, and uploaded data. 
                    This action cannot be undone.
                </p>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        Type your username <strong>{{ user.username }}</strong> to confirm:
                    </label>
                    <input type="text" id="delete-username-confirm" 
                           class="w-full p-2 border rounded"
                           placeholder="Enter your username">
                </div>
                <div class="flex gap-3">
                    <button onclick="deleteAccount()" id="delete-account-btn" disabled
                            class="bg-red-600 text-white px-4 py-2 rounded hover:bg-red-700 transition disabled:bg-gray-400 disabled:cursor-not-allowed">
                        Delete Account
                    </button>
                    <button onclick="closeDeleteModal()" class="bg-gray-300 text-gray-700 px-4 py-2 rounded hover:bg-gray-400 transition">
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>

    <footer class="bg-gray-50 border-t border-gray-100 py-8">
        <div class="container mx-auto px-4">
            <div class="flex flex-col md:flex-row justify-between items-center">
                <div class="flex items-center mb-4 md:mb-0">
                    <div class="w-8 h-8 flex items-center justify-center mr-2">
                        <i class="ri-earth-line text-primary ri-lg" aria-hidden="true"></i>
                    </div>
                    <p class="text-primary">
                        Made with <span class="text-red-500" aria-label="love">❤</span> by 
                        <a href="https://envirodatagov.org" rel="nofollow" class="text-accent hover:text-primary">EDGI</a> and 
                        <a href="https://screening-tools.com/" rel="nofollow" class="text-accent hover:text-primary">Public Environmental Data Partners</a>.
                    </p>
                </div>
                <div>
                    <a href="https://opendatacommons.org/licenses/odbl/" class="text-accent hover:text-primary">Data licensed under ODbL</a>
                </div>
            </div>
        </div>
    </footer>

    <script>
        function togglePassword(inputId) {
            const passwordInput = document.getElementById(inputId);
            const icon = passwordInput.nextElementSibling.querySelector('i');
            
            if (passwordInput.type === 'password') {
                passwordInput.type = 'text';
                icon.className = 'ri-eye-line';
            } else {
                passwordInput.type = 'password';
                icon.className = 'ri-eye-off-line';
            }
        }

        function showResetConfirm() {
            document.getElementById('reset-confirm-modal').classList.remove('hidden');
        }

        function closeResetModal() {
            document.getElementById('reset-confirm-modal').classList.add('hidden');
        }

        function resetAccount() {
            // This would be implemented with proper backend endpoint
            alert('Reset account feature would be implemented with proper confirmation and backend processing');
            closeResetModal();
        }

        function showDeleteConfirm() {
            document.getElementById('delete-confirm-modal').classList.remove('hidden');
        }

        function closeDeleteModal() {
            document.getElementById('delete-confirm-modal').classList.add('hidden');
            document.getElementById('delete-username-confirm').value = '';
            document.getElementById('delete-account-btn').disabled = true;
        }

        function deleteAccount() {
            const username = document.getElementById('delete-username-confirm').value;
            if (username === '{{ user.username }}') {
                // This would be implemented with proper backend endpoint
                alert('Delete account feature would be implemented with proper confirmation and backend processing');
                closeDeleteModal();
            }
        }

        // Enable delete button when username matches
        document.getElementById('delete-username-confirm').addEventListener('input', function() {
            const deleteBtn = document.getElementById('delete-account-btn');
            deleteBtn.disabled = this.value !== '{{ user.username }}';
        });

        // Close modals when clicking outside
        document.getElementById('reset-confirm-modal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeResetModal();
            }
        });

        document.getElementById('delete-confirm-modal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeDeleteModal();
            }
        });

        // Validate password confirmation
        document.getElementById('confirm_password').addEventListener('input', function() {
            const newPassword = document.getElementById('new_password').value;
            const confirmPassword = this.value;
            
            if (newPassword !== confirmPassword) {
                this.setCustomValidity('Passwords do not match');
            } else {
                this.setCustomValidity('');
            }
        });

        // Clear messages after 5 seconds
        setTimeout(function() {
            const alerts = document.querySelectorAll('.bg-green-100, .bg-red-100');
            alerts.forEach(alert => {
                alert.style.transition = 'opacity 0.5s';
                alert.style.opacity = '0';
                setTimeout(() => alert.remove(), 500);
            });
        }, 5000);
    </script>
</body>
</html>