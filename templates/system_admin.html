
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=0.9">
    <meta name="robots" content="noindex">
    <title>System Administration - {{ content.title.content | default("Resette Portal") }}</title>
    <script src="https://cdn.tailwindcss.com/3.4.16"></script>
    <script src="/static/js/tailwind.config.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/remixicon/4.6.0/remixicon.min.css">
    <link rel="stylesheet" href="/static/styles.css">
    <link rel="icon" href="/static/favicon.ico">
</head>
<body class="bg-background">
    <header class="fixed top-0 left-0 right-0 z-50 bg-header text-white shadow-md">
        <div class="container mx-auto px-4 h-20 flex items-center justify-between">
            <div class="flex items-center">
                <div class="w-10 h-10 flex items-center justify-center mr-3">
                    <i class="ri-admin-line text-white ri-2x" aria-hidden="true"></i>
                </div>
                <div class="text-xl font-semibold">System Administration</div>
            </div>
            {% if actor %}
                <div>
                    <a href="/manage-databases" class="text-white hover:text-accent mr-4">My Databases</a>
                    <a href="#" onclick="showTab('settings'); return false;" class="text-white hover:text-accent mr-4">System Settings</a>
                    <a href="/system-trash" class="text-white hover:text-accent mr-4">System Trash</a>

                    <a href="/profile" class="text-white hover:text-accent mr-4">Profile ({{ actor.username }})</a>
                    <a href="/logout" class="text-white hover:text-accent">Logout</a>
                </div>
            {% endif %}
        </div>
    </header>
    
    <main class="flex-grow pt-20 pb-6">
    <section class="container mx-auto px-4 mt-6">
        <!-- Header - 90% width -->
        <div class="flex justify-between items-center mb-6 w-[90%] mx-auto">
            <div>
                <h1 class="text-3xl font-bold text-primary">System Administration</h1>
                <p class="text-textlight mt-2">Manage users, databases, system settings, and activity</p>
            </div>
            <div class="flex gap-3">
                <a href="/edit-portal-homepage" class="bg-blue-500 text-white px-6 py-3 rounded-button hover:bg-blue-600 transition font-medium">
                    <i class="ri-palette-line mr-2"></i>Edit Portal Homepage
                </a>
                <a href="/register" class="bg-accent text-white px-6 py-3 rounded-button hover:bg-primary transition font-medium">
                    <i class="ri-user-add-line mr-2"></i>Add New User
                </a>
            </div>
        </div>

        <!-- Success/Error Messages - 90% width -->
        {% if success %}
            <div class="bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded mb-6 w-[90%] mx-auto">
                <p class="text-sm">{{ success }}</p>
            </div>
        {% endif %}
        {% if error %}
            <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-6 w-[90%] mx-auto">
                <p class="text-sm">{{ error }}</p>
            </div>
        {% endif %}

        <!-- Statistics Cards - 90% width (4 cards only) -->
        <div class="w-[90%] mx-auto">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                <a href="#" onclick="showTab('users'); return false;" class="block bg-blue-500 rounded-card p-6 text-white hover:bg-blue-600 transition-all duration-200 transform hover:scale-105">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="text-3xl font-bold">{{ users|length }}</h3>
                            <p class="text-blue-100">Total Users</p>
                        </div>
                        <i class="ri-user-line text-4xl text-blue-200"></i>
                    </div>
                </a>
                
                <a href="#" onclick="showTab('databases'); return false;" class="block bg-green-500 rounded-card p-6 text-white hover:bg-green-600 transition-all duration-200 transform hover:scale-105">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="text-3xl font-bold">{{ databases|length }}</h3>
                            <p class="text-green-100">Active Databases</p>
                        </div>
                        <i class="ri-database-line text-4xl text-green-200"></i>
                    </div>
                </a>
                
                <a href="#" onclick="showTab('activity'); return false;" class="block bg-purple-500 rounded-card p-6 text-white hover:bg-purple-600 transition-all duration-200 transform hover:scale-105">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="text-3xl font-bold">{{ activity_logs|length }}</h3>
                            <p class="text-orange-100">Recent Activities</p>
                        </div>
                        <i class="ri-activity-line text-4xl text-orange-200"></i>
                    </div>
                </a>

                <a href="#" onclick="showTab('settings'); return false;" class="block bg-indigo-500 rounded-card p-6 text-white hover:bg-indigo-600 transition-all duration-200 transform hover:scale-105">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="text-2xl font-bold"><i class="ri-settings-3-line"></i></h3>
                            <p class="text-indigo-100">System Settings</p>
                        </div>
                        <i class="ri-settings-gear-line text-4xl text-indigo-200"></i>
                    </div>
                </a>
            </div>

            <!-- Tab Navigation -->
            <div class="bg-card rounded-card border border-border">
                <div class="border-b border-border">
                    <nav class="flex">
                        <button onclick="showTab('databases')" id="databases-tab" class="tab-button active px-6 py-4 font-medium text-accent border-b-2 border-accent">
                            <i class="ri-database-line mr-2"></i>Databases
                        </button>
                        <button onclick="showTab('users')" id="users-tab" class="tab-button px-6 py-4 font-medium text-textlight hover:text-accent">
                            <i class="ri-user-line mr-2"></i>Users
                        </button>
                        <button onclick="showTab('activity')" id="activity-tab" class="tab-button px-6 py-4 font-medium text-textlight hover:text-accent">
                            <i class="ri-activity-line mr-2"></i>Activity Logs
                        </button>
                        <button onclick="showTab('settings')" id="settings-tab" class="tab-button px-6 py-4 font-medium text-textlight hover:text-accent">
                            <i class="ri-settings-3-line mr-2"></i>Settings
                        </button>
                    </nav>
                </div>

                <!-- Databases Tab (Default) -->
                <div id="databases-content" class="tab-content p-6">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-xl font-semibold text-primary">Database Overview</h3>
                        <div class="flex gap-2">
                            <!-- Database Search -->
                            <div class="relative">
                                <input type="text" id="database-search" placeholder="Search databases..." 
                                    class="pl-10 pr-4 py-2 border rounded-button focus:outline-none focus:ring-2 focus:ring-accent text-sm"
                                    onkeyup="filterDatabases()">
                                <i class="ri-search-line absolute left-3 top-2.5 text-gray-400"></i>
                            </div>
                            <!-- Status Filter -->
                            <select id="status-filter" onchange="filterDatabases()" class="px-3 py-2 border rounded text-sm">
                                <option value="">All Statuses</option>
                                <option value="Published">Published</option>
                                <option value="Draft">Draft</option>
                                <option value="Unpublished">Unpublished</option>
                            </select>
                            <!-- Owner Filter -->
                            <select id="owner-filter" onchange="filterDatabases()" class="px-3 py-2 border rounded text-sm">
                                <option value="">All Owners</option>
                                {% for user in users %}
                                <option value="{{ user.username }}">{{ user.username }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead>
                                <tr class="bg-gray-50">
                                    <th class="text-left p-3 font-medium text-white bg-header">Database Name</th>
                                    <th class="text-left p-3 font-medium text-white bg-header">Owner</th>
                                    <th class="text-left p-3 font-medium text-white bg-header">Status</th>
                                    <th class="text-left p-3 font-medium text-white bg-header">Created</th>
                                    <th class="text-left p-3 font-medium text-white bg-header">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="databases-table-body">
                                {% for db in databases %}
                                    <tr class="border-b hover:bg-gray-50 transition database-row" 
                                        data-status="{{ db.status }}"
                                        data-name="{{ db.db_name.lower() }}"
                                        data-owner="{{ db.username.lower() }}">
                                        <td class="p-3">
                                            <div class="flex items-center">
                                                <div class="w-8 h-8 bg-green-500 rounded-full flex items-center justify-center mr-3">
                                                    <i class="ri-database-line text-white text-sm"></i>
                                                </div>
                                                <span class="font-medium">{{ db.db_name.replace('_', ' ').title() }}</span>
                                            </div>
                                        </td>
                                        <td class="p-3 text-textlight">{{ db.username }}</td>
                                        <td class="p-3">
                                            <span class="px-2 py-1 rounded-full text-xs font-medium 
                                                {% if db.status == 'Published' %}bg-green-100 text-green-800
                                                {% elif db.status == 'Unpublished' %}bg-blue-100 text-blue-800
                                                {% elif db.status == 'Trashed' %}bg-red-100 text-red-800
                                                {% else %}bg-yellow-100 text-yellow-800{% endif %}">
                                                {{ db.status }}
                                            </span>
                                        </td>
                                        <td class="p-3 text-textlight">{{ db.created_at[:10] if db.created_at else 'N/A' }}</td>
                                        <td class="p-3">
                                            <div class="flex gap-2">
                                                <!-- View Homepage Button (for all databases) -->
                                                {% if db.status != 'Trashed' %}
                                                    <a href="/db/{{ db.db_name }}/homepage" target="_blank" 
                                                    class="text-green-500 hover:text-green-700 text-sm px-2 py-1 rounded transition">
                                                        <i class="ri-home-line mr-1"></i>View Homepage
                                                    </a>
                                                {% endif %}

                                                <!-- View Database Button -->
                                                {% if db.status != 'Trashed' %}
                                                    <a href="/{{ db.db_name }}" target="_blank" 
                                                    class="text-purple-500 hover:text-purple-700 text-sm px-2 py-1 rounded transition">
                                                        <i class="ri-external-link-line mr-1"></i>View Database
                                                    </a>
                                                {% endif %}

                                                <!-- View Details Button -->
                                                <button onclick="toggleDatabaseDetails('{{ db.db_id }}')" 
                                                        class="text-indigo-500 hover:text-indigo-700 text-sm px-2 py-1 rounded transition bg-transparent border-none cursor-pointer">
                                                    <i class="ri-eye-line mr-1"></i>View Details
                                                </button>

                                                <!-- Move to Trash Button (Admin Override) -->
                                                {% if db.status != 'Trashed' %}
                                                    <a href="/db/{{ db.db_name }}/trash" 
                                                    class="text-red-500 hover:text-red-700 text-sm px-2 py-1 rounded transition"
                                                    onclick="return confirm('Admin override: Move {{ db.db_name.replace('_', ' ').title() }} to trash? This will bypass user permissions.')">
                                                        <i class="ri-delete-bin-line mr-1"></i>Move to Trash
                                                    </a>
                                                {% endif %}
                                            </div>
                                        </td>
                                    </tr>
                                    <!-- Expandable Details Section -->
                                    <tr id="details-{{ db.db_id }}" class="hidden database-details bg-gray-50">
                                        <td colspan="5" class="p-4">
                                            <div class="bg-white rounded border border-gray-200 p-4">
                                                <h4 class="font-semibold text-gray-800 mb-3">Database Details</h4>
                                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                                                    <div>
                                                        <div class="space-y-2">
                                                            <div><strong>Database ID:</strong> {{ db.db_id }}</div>
                                                            <div><strong>Name:</strong> {{ db.db_name }}</div>
                                                            <div><strong>Owner:</strong> {{ db.username }}</div>
                                                            <div><strong>Status:</strong> {{ db.status }}</div>
                                                            <div><strong>Created:</strong> {{ db.created_at[:19] if db.created_at else 'N/A' }}</div>
                                                        </div>
                                                    </div>
                                                    <div>
                                                        <div class="space-y-2">
                                                            <div><strong>Website URL:</strong> 
                                                                {% if db.website_url %}
                                                                    <a href="{{ db.website_url }}" target="_blank" class="text-blue-500 hover:text-blue-700">{{ db.website_url }}</a>
                                                                {% else %}
                                                                    Not available
                                                                {% endif %}
                                                            </div>
                                                            <div><strong>File Path:</strong> <span class="font-mono text-xs">{{ db.db_name }}.db</span></div>
                                                            <div id="stats-{{ db.db_id }}" class="text-gray-600">
                                                                <div><strong>Tables:</strong> <span class="table-count">{{ db.table_count | default('0') }}</span></div>
                                                                <div><strong>Records:</strong> <span class="record-count">{{ "{:,}".format(db.total_records | default(0)) }}</span></div>
                                                                <div><strong>File Size:</strong> <span class="file-size">{{ "%.1f"|format(db.file_size | default(0)) }} KB</span></div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Users Tab -->
                <div id="users-content" class="tab-content p-6 hidden">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-xl font-semibold text-primary">User Management</h3>
                        <div class="flex gap-3">
                            <!-- User Search -->
                            <div class="relative">
                                <input type="text" id="user-search" placeholder="Search users..." 
                                       class="pl-10 pr-4 py-2 border rounded-button focus:outline-none focus:ring-2 focus:ring-accent text-sm"
                                       onkeyup="filterUsers()">
                                <i class="ri-search-line absolute left-3 top-2.5 text-gray-400"></i>
                            </div>
                            <!-- Role Filter -->
                            <select id="role-filter" onchange="filterUsers()" class="px-3 py-2 border rounded-button text-sm focus:outline-none focus:ring-2 focus:ring-accent">
                                <option value="">All Roles</option>
                                <option value="system_user">System User</option>
                                <option value="system_admin">System Admin</option>
                            </select>
                            <a href="/register" class="bg-accent text-white px-4 py-2 rounded-button hover:bg-primary transition text-sm">
                                <i class="ri-user-add-line mr-1"></i>Add User
                            </a>
                        </div>
                    </div>
                    
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead>
                                <tr class="bg-gray-50">
                                    <th class="text-left p-3 font-medium text-white bg-header">Username</th>
                                    <th class="text-left p-3 font-medium text-white bg-header">Email</th>
                                    <th class="text-left p-3 font-medium text-white bg-header">Role</th>
                                    <th class="text-left p-3 font-medium text-white bg-header">Password Status</th>
                                    <th class="text-left p-3 font-medium text-white bg-header">Registered</th>
                                    <th class="text-left p-3 font-medium text-white bg-header">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="users-table-body">
                                {% for user in users %}
                                    <tr class="border-b hover:bg-gray-50 transition user-row" 
                                        data-username="{{ user.username.lower() }}" 
                                        data-email="{{ user.email.lower() }}" 
                                        data-role="{{ user.role }}">
                                        <td class="p-3">
                                            <div class="flex items-center">
                                                <div class="w-8 h-8 bg-accent rounded-full flex items-center justify-center mr-3">
                                                    <i class="ri-user-line text-white text-sm"></i>
                                                </div>
                                                <span class="font-medium">{{ user.username }}</span>
                                            </div>
                                        </td>
                                        <td class="p-3 text-textlight">{{ user.email }}</td>
                                        <td class="p-3">
                                            <span class="px-2 py-1 rounded-full text-xs font-medium 
                                                {% if user.role == 'system_admin' %}bg-red-100 text-red-800{% else %}bg-blue-100 text-blue-800{% endif %}">
                                                {{ user.role.replace('_', ' ').title() }}
                                            </span>
                                        </td>
                                        <td class="p-3">
                                            {% if user.must_change_password %}
                                                <span class="px-2 py-1 rounded-full text-xs font-medium bg-orange-100 text-orange-800">
                                                    <i class="ri-key-2-line mr-1"></i>Must Change
                                                </span>
                                            {% else %}
                                                <span class="px-2 py-1 rounded-full text-xs font-medium bg-green-100 text-green-800">
                                                    <i class="ri-shield-check-line mr-1"></i>Active
                                                </span>
                                            {% endif %}
                                        </td>
                                        <td class="p-3 text-textlight">{{ user.created_at[:10] if user.created_at else 'N/A' }}</td>
                                        <td class="p-3">
                                            <div class="flex gap-2">
                                                <!-- Edit User Role Button -->
                                                <button onclick="editUserRole('{{ user.user_id }}', '{{ user.username }}', '{{ user.role }}')" 
                                                        class="text-accent hover:text-primary text-sm px-2 py-1 rounded transition">
                                                    <i class="ri-edit-line mr-1"></i>Edit Role
                                                </button>
                                                
                                                <!-- Reset Password Button -->
                                                <button onclick="resetUserPassword('{{ user.user_id }}', '{{ user.username }}')" 
                                                        class="text-orange-500 hover:text-orange-700 text-sm px-2 py-1 rounded transition">
                                                    <i class="ri-key-2-line mr-1"></i>Reset Password
                                                </button>
                                                
                                                <!-- Delete User Button (only if not current user) -->
                                                {% if user.username != actor.username %}
                                                    <button onclick="deleteUser('{{ user.user_id }}', '{{ user.username }}')" 
                                                            class="text-red-500 hover:text-red-700 text-sm px-2 py-1 rounded transition">
                                                        <i class="ri-delete-bin-line mr-1"></i>Delete
                                                    </button>
                                                {% else %}
                                                    <span class="text-gray-400 text-sm px-2 py-1">Current User</span>
                                                {% endif %}
                                            </div>
                                        </td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Activity Logs Tab -->
                <div id="activity-content" class="tab-content p-6 hidden">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-xl font-semibold text-primary">Recent Activity</h3>
                        <select id="activity-filter" onchange="filterActivity()" class="px-3 py-2 border rounded text-sm">
                            <option value="">All Actions</option>
                            <option value="login">Login</option>
                            <option value="register">Register</option>
                            <option value="create_database">Create Database</option>
                            <option value="publish_database">Publish Database</option>
                            <option value="csv_upload">Upload CSV</option>
                            <option value="edit_portal_homepage">Edit Portal</option>
                            <option value="trash_database">Trash Database</option>
                            <option value="restore_database">Restore Database</option>
                        </select>
                    </div>
                    
                    <div class="space-y-4 max-h-96 overflow-y-auto" id="activity-logs-container">
                        {% for log in activity_logs %}
                            <div class="flex items-start p-4 bg-gray-50 rounded activity-log" data-action="{{ log.action }}">
                                <div class="w-10 h-10 rounded-full flex items-center justify-center mr-4
                                    {% if log.action == 'login' %}bg-blue-100 text-blue-600
                                    {% elif log.action == 'register' %}bg-green-100 text-green-600
                                    {% elif log.action == 'create_database' %}bg-green-100 text-green-600
                                    {% elif log.action == 'publish_database' %}bg-purple-100 text-purple-600
                                    {% elif log.action == 'csv_upload' %}bg-orange-100 text-orange-600
                                    {% elif log.action == 'edit_portal_homepage' %}bg-indigo-100 text-indigo-600
                                    {% elif log.action == 'trash_database' %}bg-red-100 text-red-600
                                    {% elif log.action == 'restore_database' %}bg-yellow-100 text-yellow-600
                                    {% else %}bg-gray-100 text-gray-600{% endif %}">
                                    <i class="ri-{% if log.action == 'login' %}login-circle-line
                                        {% elif log.action == 'register' %}user-add-line
                                        {% elif log.action == 'create_database' %}database-line
                                        {% elif log.action == 'publish_database' %}global-line
                                        {% elif log.action == 'csv_upload' %}upload-line
                                        {% elif log.action == 'edit_portal_homepage' %}palette-line
                                        {% elif log.action == 'trash_database' %}delete-bin-line
                                        {% elif log.action == 'restore_database' %}refresh-line
                                        {% else %}activity-line{% endif %} text-sm"></i>
                                </div>
                                <div class="flex-1">
                                    <div class="flex items-center justify-between">
                                        <h4 class="font-medium text-text">{{ log.action.replace('_', ' ').title() }}</h4>
                                        <span class="text-xs text-textlight">{{ log.timestamp[:16] if log.timestamp else 'N/A' }}</span>
                                    </div>
                                    <p class="text-textlight text-sm mt-1">{{ log.details }}</p>
                                    <div class="text-xs text-textlight mt-2">
                                        User ID: {{ log.user_id[:8] if log.user_id else 'Unknown' }}...
                                    </div>
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                </div>

                <!-- Settings Tab -->
                <div id="settings-content" class="tab-content p-6 hidden">
                    <h3 class="text-xl font-semibold text-primary mb-6">System Settings</h3>
                    
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                        <!-- System Configuration button -->
                        <div class="bg-gray-50 rounded-lg p-6">
                            <h4 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
                                <i class="ri-settings-line mr-2"></i>System Configuration
                            </h4>
                            
                            <form id="system-settings-form" class="space-y-4">
                                <input type="hidden" name="csrftoken" value="{{ csrftoken() }}">
                                <input type="hidden" name="action" value="update_system_settings">
                                <input type="hidden" name="redirect_tab" value="settings">
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">
                                        Trash Retention Days
                                    </label>
                                    <input type="number" name="trash_retention_days" 
                                        value="{{ system_settings.trash_retention_days | default(30) }}" 
                                        min="1" max="365"
                                        class="w-full p-3 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-accent">
                                    <p class="text-xs text-gray-500 mt-1">Days before permanently deleting trashed databases</p>
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">
                                        Max Databases Per User
                                    </label>
                                    <input type="number" name="max_databases_per_user" 
                                        value="{{ system_settings.max_databases_per_user | default(10) }}" 
                                        min="1" max="100"
                                        class="w-full p-3 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-accent">
                                    <p class="text-xs text-gray-500 mt-1">Maximum number of databases each user can create</p>
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">
                                        DB Max File Size (MB)
                                    </label>
                                    <input type="number" name="max_file_size_mb" 
                                        value="{{ ((system_settings.max_file_size  | int) // (1024*1024)) if system_settings.max_file_size else 50 }}" 
                                        min="1" max="500"
                                        class="w-full p-3 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-accent">
                                    <p class="text-xs text-gray-500 mt-1">Maximum Database file size for uploads in megabytes</p>
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">
                                        Picture Max File Size (MB)
                                    </label>
                                    <input type="number" name="max_img_size_mb" 
                                        value="{{ ((system_settings.max_img_size | int) // (1024*1024)) if system_settings.max_img_size else 5 }}" 
                                        min="1" max="500"
                                        class="w-full p-3 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-accent">
                                    <p class="text-xs text-gray-500 mt-1">Maximum picture file size for uploads in megabytes</p>
                                </div>

                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">
                                        Allowed File Extensions
                                    </label>
                                    <input type="text" name="allowed_extensions" 
                                        value="{{ system_settings.allowed_extensions | default('.jpg,.png,.csv,.xls,.xlsx,.txt') }}" 
                                        class="w-full p-3 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-accent">
                                    <p class="text-xs text-gray-500 mt-1">Comma-separated list of allowed file extensions (e.g., .csv,.xlsx,.txt)</p>
                                </div>
                                
                                <button type="button" onclick="saveSystemSettingsWithConfirmation()" 
                                        class="w-full bg-accent text-white py-3 px-4 rounded-button hover:bg-primary transition font-medium">
                                    <i class="ri-save-line mr-2"></i>Save System Settings
                                </button>
                            </form>
                        </div>

                        <!-- Domain Management button -->
                        <div class="bg-gray-50 rounded-lg p-6">
                            <h4 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
                                <i class="ri-global-line mr-2"></i>Web CSV Domain Management
                            </h4>
                            
                            <div class="mb-4 p-4 bg-blue-50 border border-blue-200 rounded">
                                <p class="text-blue-800 text-sm">
                                    <strong>Security Policy:</strong> All domains are allowed by default except those in the blocked list below. 
                                    Add domains to the blocked list to prevent users from importing CSV files from those sources.
                                </p>
                            </div>
                            
                            <!-- Add Blocked Domain -->
                            <form id="block-domain-form" class="mb-6">
                                <input type="hidden" name="csrftoken" value="{{ csrftoken() }}">
                                <input type="hidden" name="action" value="add_blocked_domain">
                                <input type="hidden" name="redirect_tab" value="settings">
                                
                                <div class="flex gap-2 mb-4">
                                    <input type="text" name="domain" id="domain-input"
                                        placeholder="example.com" 
                                        required
                                        class="flex-1 p-3 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-accent">
                                    <button type="button" onclick="blockDomainWithConfirmation()"
                                            class="bg-red-500 text-white px-4 py-3 rounded hover:bg-red-600 transition">
                                        <i class="ri-forbid-line mr-1"></i>Block Domain
                                    </button>
                                </div>
                                <p class="text-xs text-gray-500 mb-4">Enter domain name without protocol (e.g., malicious-site.com)</p>
                            </form>

                            <!-- Blocked Domains List -->
                            <div class="space-y-2 max-h-64 overflow-y-auto">
                                <h5 class="font-medium text-gray-700 mb-3">Currently Blocked Domains</h5>
                                
                                {% if blocked_domains %}
                                    {% for domain in blocked_domains %}
                                        <div class="flex items-center justify-between p-3 bg-white border border-gray-200 rounded">
                                            <div class="flex items-center">
                                                <i class="ri-forbid-line text-red-500 mr-2"></i>
                                                <span class="font-mono text-sm">{{ domain.domain }}</span>
                                            </div>
                                            <form method="post" action="/admin/update-settings" class="inline">
                                                <input type="hidden" name="csrftoken" value="{{ csrftoken() }}">
                                                <input type="hidden" name="action" value="remove_blocked_domain">
                                                <input type="hidden" name="domain" value="{{ domain.domain }}">
                                                <input type="hidden" name="redirect_tab" value="settings">
                                                <button type="submit" 
                                                        class="text-red-500 hover:text-red-700 text-sm px-2 py-1 rounded transition"
                                                        onclick="return confirm('Remove {{ domain.domain }} from blocked list?')">
                                                    <i class="ri-delete-bin-line mr-1"></i>Remove
                                                </button>
                                            </form>
                                        </div>
                                    {% endfor %}
                                {% else %}
                                    <div class="text-center py-8 text-gray-500">
                                        <i class="ri-shield-check-line text-3xl mb-2 block"></i>
                                        <p class="text-sm">No domains are currently blocked</p>
                                        <p class="text-xs">All domains are allowed for CSV imports</p>
                                    </div>
                                {% endif %}
                            </div>

                            <!-- Common Domains to Block (Suggestions) -->
                            <div class="mt-6 p-4 bg-yellow-50 border border-yellow-200 rounded">
                                <h5 class="font-medium text-yellow-800 mb-2">
                                    <i class="ri-lightbulb-line mr-1"></i>Common Domains to Consider Blocking
                                </h5>
                                <div class="text-yellow-700 text-xs space-y-1">
                                    <p>• Social media platforms (twitter.com, facebook.com)</p>
                                    <p>• File sharing services with potential security risks</p>
                                    <p>• Known malicious or suspicious domains</p>
                                    <p>• Personal file hosting that might be unreliable</p>
                                </div>
                            </div>
                        </div>

                        <!-- System Statistics (unchanged) -->
                        <div class="bg-gray-50 rounded-lg p-6">
                            <h4 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
                                <i class="ri-bar-chart-line mr-2"></i>System Statistics
                            </h4>
                            
                            <div class="grid grid-cols-2 gap-4">
                                <div class="bg-white p-4 rounded border">
                                    <div class="text-2xl font-bold text-blue-600">{{ system_stats.total_db | default(0) }}</div>
                                    <div class="text-gray-600 text-sm">Total Databases</div>
                                </div>
                                <div class="bg-white p-4 rounded border">
                                    <div class="text-2xl font-bold text-blue-600">{{ system_stats.total_uploads | default(0) }}</div>
                                    <div class="text-gray-600 text-sm">Total File Uploads</div>
                                </div>
                                <div class="bg-white p-4 rounded border">
                                    <div class="text-2xl font-bold text-green-600">{{ system_stats.total_storage_mb | default(0) }}</div>
                                    <div class="text-gray-600 text-sm">Storage Used (MB)</div>
                                </div>
                                <div class="bg-white p-4 rounded border">
                                    <div class="text-2xl font-bold text-purple-600">{{ system_stats.avg_db_size | default(0) }}</div>
                                    <div class="text-gray-600 text-sm">Avg DB Size (KB)</div>
                                </div>
                            </div>
                            <!-- Enhanced File Size Info -->
                            <div class="mt-6 p-4 bg-blue-50 border border-blue-200 rounded">
                                <h5 class="font-medium text-blue-800 mb-2">
                                    <i class="ri-information-line mr-1"></i>File Upload Information
                                </h5>
                                <div class="text-blue-700 text-sm space-y-1">
                                    <p>• Current max file size: <strong>{{ (system_settings.max_file_size / (1024*1024)) | int if system_settings.max_file_size else 50 }}MB</strong></p>
                                    <p>• Images are automatically optimized for web display</p>
                                    <p>• Header images are resized to max 1680x450px</p>
                                    <p>• Optimization typically reduces file size by 30-70%</p>
                                </div>
                            </div>
                        </div>

                        <!-- Maintenance Actions - CLEAN -->
                        <div class="bg-gray-50 rounded-lg p-6">
                            <h4 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
                                <i class="ri-tools-line mr-2"></i>Maintenance Actions
                            </h4>
                            
                            <div class="space-y-3">
                                <button onclick="window.location.href='/admin/confirm-password?operation=clear_old_trash'" 
                                        class="w-full bg-orange-500 text-white py-3 px-4 rounded hover:bg-orange-600 transition text-sm font-medium">
                                    <i class="ri-delete-bin-line mr-2"></i>Clear Expired Trash ({{ expired_trash_count | default(0) }} items)
                                </button>
                                
                                <button onclick="window.location.href='/admin/confirm-password?operation=optimize_database'" 
                                        class="w-full bg-blue-500 text-white py-3 px-4 rounded hover:bg-blue-600 transition text-sm font-medium">
                                    <i class="ri-database-line mr-2"></i>Optimize Database
                                </button>
                                
                                <button onclick="window.location.href='/admin/confirm-password?operation=regenerate_thumbnails'" 
                                        class="w-full bg-purple-500 text-white py-3 px-4 rounded hover:bg-purple-600 transition text-sm font-medium">
                                    <i class="ri-image-line mr-2"></i>Optimize Images (Regenerate Thumbnails)
                                </button>
                                
                                <button onclick="window.location.href='/admin/confirm-password?operation=export_system_logs'" 
                                        class="w-full bg-indigo-500 text-white py-3 px-4 rounded hover:bg-indigo-600 transition text-sm font-medium">
                                    <i class="ri-download-line mr-2"></i>Export System Logs
                                </button>
                            </div>

                            <div class="mt-6 p-4 bg-red-50 border border-red-200 rounded">
                                <h5 class="font-medium text-red-800 mb-2">Danger Zone</h5>
                                <button onclick="window.location.href='/admin/confirm-password?operation=reset_system_settings'" 
                                        class="bg-red-600 text-white px-4 py-2 rounded hover:bg-red-700 transition text-sm font-medium">
                                    <i class="ri-refresh-line mr-1"></i>Reset All Settings to Default
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>
    </main>

    <!-- User Edit Modal -->
    <div id="edit-user-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-white rounded-lg max-w-md w-full p-6">
                <h3 class="text-lg font-semibold mb-4">Edit User Role</h3>
                <form id="edit-user-form" method="post" action="/edit-user-role">
                    <input type="hidden" name="csrftoken" value="{{ csrftoken() }}">
                    <input type="hidden" id="edit-user-id" name="user_id" value="">
                    
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Username</label>
                        <input type="text" id="edit-username" readonly class="w-full p-2 border rounded bg-gray-100">
                    </div>
                    
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Role</label>
                        <select id="edit-role" name="role" class="w-full p-2 border rounded">
                            <option value="system_user">System User</option>
                            <option value="system_admin">System Admin</option>
                        </select>
                    </div>
                    
                    <div class="flex gap-3">
                        <button type="submit" class="bg-accent text-white px-4 py-2 rounded hover:bg-primary transition">
                            Save Changes
                        </button>
                        <button type="button" onclick="closeEditModal()" class="bg-gray-300 text-gray-700 px-4 py-2 rounded hover:bg-gray-400 transition">
                            Cancel
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Reset Password Modal -->
    <div id="reset-password-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-white rounded-lg max-w-md w-full p-6">
                <h3 class="text-lg font-semibold mb-4 text-orange-800">
                    <i class="ri-key-2-line mr-2"></i>Reset User Password
                </h3>
                
                <div class="mb-6 p-4 bg-orange-50 border border-orange-200 rounded">
                    <div class="flex items-start">
                        <i class="ri-alert-line text-orange-600 mt-1 mr-3"></i>
                        <div>
                            <h4 class="text-orange-800 font-semibold mb-1">Password Reset Action</h4>
                            <p class="text-orange-700 text-sm">
                                This will reset the user's password and require them to change it on their next login.
                                You will be asked to confirm with your administrator password.
                            </p>
                        </div>
                    </div>
                </div>
                
                <!-- UPDATED: Remove form tags, just use div -->
                <div id="reset-password-form" class="space-y-4">
                    <input type="hidden" id="reset-user-id" value="">
                    
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Username</label>
                        <input type="text" id="reset-username" readonly class="w-full p-2 border rounded bg-gray-100">
                    </div>
                    
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Temporary Password</label>
                        <div class="flex gap-2">
                            <input type="text" id="temp-password" readonly 
                                class="flex-1 p-2 border rounded bg-gray-100 font-mono text-sm">
                            <button type="button" onclick="generateTempPassword()" 
                                    class="bg-blue-500 text-white px-3 py-2 rounded hover:bg-blue-600 transition text-sm">
                                <i class="ri-refresh-line mr-1"></i>Generate
                            </button>
                            <button type="button" onclick="copyTempPassword()" 
                                    class="bg-gray-500 text-white px-3 py-2 rounded hover:bg-gray-600 transition text-sm">
                                <i class="ri-file-copy-line mr-1"></i>Copy
                            </button>
                        </div>
                        <p class="text-xs text-gray-500 mt-1">Click Generate to create a secure temporary password</p>
                    </div>
                    
                    <div class="mb-6 p-3 bg-yellow-50 border border-yellow-200 rounded">
                        <h4 class="text-yellow-800 font-medium text-sm mb-2">
                            <i class="ri-information-line mr-1"></i>Important Notes:
                        </h4>
                        <ul class="text-yellow-700 text-xs space-y-1">
                            <li>• User will be forced to change password on next login</li>
                            <li>• Make sure to securely share the temporary password with the user</li>
                            <li>• The temporary password will expire after first use</li>
                            <li>• This action will be logged and requires admin password confirmation</li>
                        </ul>
                    </div>
                    
                    <div class="flex gap-3">
                        <!-- UPDATED: Call confirmation function instead of form submit -->
                        <button type="button" onclick="confirmResetPassword()" id="confirm-reset-btn" disabled
                                class="bg-orange-500 text-white px-4 py-2 rounded hover:bg-orange-600 transition disabled:bg-gray-400 disabled:cursor-not-allowed">
                            <i class="ri-shield-check-line mr-1"></i>Confirm & Require Admin Password
                        </button>
                        <button type="button" onclick="closeResetModal()" 
                                class="bg-gray-300 text-gray-700 px-4 py-2 rounded hover:bg-gray-400 transition">
                            <i class="ri-close-line mr-1"></i>Cancel
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- NEW: Admin Password Confirmation Modal -->
    <div id="admin-password-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-white rounded-lg max-w-md w-full p-6">
                <!-- Modal Header -->
                <div class="flex items-center mb-4">
                    <div class="w-10 h-10 flex items-center justify-center mr-3 bg-red-100 rounded-full">
                        <i class="ri-shield-check-line text-red-600 text-xl"></i>
                    </div>
                    <div>
                        <h3 class="text-lg font-semibold text-gray-800">Security Verification Required</h3>
                        <p class="text-sm text-gray-600">Administrator password confirmation needed</p>
                    </div>
                </div>

                <!-- Operation Details -->
                <div class="mb-6 p-4 bg-yellow-50 border border-yellow-200 rounded">
                    <h4 class="font-medium text-yellow-800 mb-2">
                        <i class="ri-alert-line mr-2"></i><span id="operation-title">System Operation</span>
                    </h4>
                    <p class="text-yellow-700 text-sm" id="operation-description">This operation requires administrator verification for security.</p>
                </div>

                <!-- Error Message -->
                <div id="password-error" class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-4 hidden">
                    <div class="flex items-center">
                        <i class="ri-error-warning-line mr-2"></i>
                        <span class="text-sm" id="error-message"></span>
                    </div>
                </div>

                <!-- Password Form -->
                <form id="admin-password-form" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-3">
                            <i class="ri-lock-line mr-2"></i>Enter your administrator password to confirm this operation:
                        </label>
                        <input type="password" 
                               id="admin-password-input" 
                               required 
                               autofocus
                               class="w-full p-4 border-2 border-red-300 rounded-button focus:outline-none focus:ring-2 focus:ring-red-500 focus:border-red-500 text-lg"
                               placeholder="Administrator password">
                    </div>
                    
                    <!-- Action Buttons -->
                    <div class="flex gap-3 pt-4">
                        <button type="submit" 
                                class="flex-1 bg-red-600 text-white py-3 px-4 rounded-button hover:bg-red-700 transition font-medium">
                            <i class="ri-shield-check-line mr-2"></i>Confirm and Proceed
                        </button>
                        <button type="button" onclick="closePasswordModal()" 
                               class="flex-1 bg-gray-300 text-gray-700 py-3 px-4 rounded-button hover:bg-gray-400 transition font-medium">
                            <i class="ri-close-line mr-2"></i>Cancel
                        </button>
                    </div>
                </form>
                
                <!-- Security Notice -->
                <div class="mt-6 p-3 bg-blue-50 border border-blue-200 rounded text-center">
                    <p class="text-blue-700 text-xs">
                        <i class="ri-information-line mr-1"></i>
                        This verification helps protect against unauthorized system changes. 
                        Your password is verified securely and not stored.
                    </p>
                </div>
            </div>
        </div>
    </div>

    <footer class="bg-gray-50 border-t border-gray-100 py-8">
        <div class="container mx-auto px-4">
            <div class="flex flex-col md:flex-row justify-between items-center">
                <div class="flex items-center mb-4 md:mb-0">
                    <div class="w-8 h-8 flex items-center justify-center mr-2">
                        <i class="ri-earth-line text-primary ri-lg" aria-hidden="true"></i>
                    </div>
                    <p class="text-primary">
                        Made with <span class="text-red-500" aria-label="love">❤</span> by 
                        <a href="https://envirodatagov.org" rel="nofollow" class="text-accent hover:text-primary">EDGI</a> and 
                        <a href="https://screening-tools.com/" rel="nofollow" class="text-accent hover:text-primary">Public Environmental Data Partners</a>.
                    </p>
                </div>
                <div>
                    <a href="https://opendatacommons.org/licenses/odbl/" class="text-accent hover:text-primary">Data licensed under ODbL</a>
                </div>
            </div>
        </div>
    </footer>

    <!-- SCRIPT SECTION -->
    <script>
        function showTab(tabName) {
            // Hide all tab contents
            const contents = document.querySelectorAll('.tab-content');
            contents.forEach(content => content.classList.add('hidden'));
            
            // Remove active class from all tabs
            const tabs = document.querySelectorAll('.tab-button');
            tabs.forEach(tab => {
                tab.classList.remove('active', 'text-accent', 'border-accent');
                tab.classList.add('text-textlight');
            });
            
            // Show selected tab content
            document.getElementById(tabName + '-content').classList.remove('hidden');
                    
            // Add active class to selected tab
            const activeTab = document.getElementById(tabName + '-tab');
            activeTab.classList.add('active', 'text-accent', 'border-accent');
            activeTab.classList.remove('text-textlight');
        }

        // UPDATED: Redirect to confirmation page for sensitive operations
        function submitWithPasswordConfirmation(operation, operationTitle) {
            // Collect form data based on operation
            let formData = new URLSearchParams();
            formData.append('operation', operation);
            
            if (operation === 'update_system_settings') {
                const form = document.getElementById('system-settings-form');
                const inputs = form.querySelectorAll('input, select, textarea');
                inputs.forEach(input => {
                    if (input.name && input.name !== 'csrftoken') {
                        formData.append(input.name, input.value);
                    }
                });
            } else if (operation === 'add_blocked_domain') {
                const form = document.getElementById('block-domain-form');
                const domainInput = form.querySelector('input[name="domain"]');
                if (domainInput && domainInput.value.trim()) {
                    formData.append('domain', domainInput.value.trim());
                } else {
                    alert('Please enter a domain name.');
                    return;
                }
            }
            
            // Redirect to confirmation page
            window.location.href = `/admin/confirm-password?${formData.toString()}`;
        }

        // Update the maintenance operations to redirect to confirmation page
        function performMaintenanceWithConfirmation(action, actionTitle) {
            const confirmMessage = `Confirm ${actionTitle}?\n\nYou will be asked to enter your administrator password for security verification.`;
            if (confirm(confirmMessage)) {
                window.location.href = `/admin/confirm-password?operation=${action}`;
            }
        }

        // UPDATED: Button click handlers that redirect to confirmation page
        function saveSystemSettingsWithConfirmation() {
            // Collect form data from the system settings form
            const form = document.getElementById('system-settings-form');
            const formData = new FormData(form);
            const params = new URLSearchParams();
            
            // Add operation type
            params.append('operation', 'update_system_settings');
            
            // Add all form fields except CSRF token
            for (let [key, value] of formData.entries()) {
                if (key !== 'csrftoken') {
                    params.append(key, value);
                }
            }
            
            // Redirect to confirmation page with form data
            window.location.href = `/admin/confirm-password?${params.toString()}`;
        }

        function blockDomainWithConfirmation() {
            const domainInput = document.getElementById('domain-input');
            const domain = domainInput.value.trim();
            
            if (!domain) {
                alert('Please enter a domain name.');
                domainInput.focus();
                return;
            }
            
            // Validate domain format (basic check)
            if (domain.includes('://') || domain.includes('/')) {
                alert('Please enter only the domain name (e.g., example.com) without protocol or paths.');
                domainInput.focus();
                return;
            }
            
            // Redirect to confirmation page with domain data
            const params = new URLSearchParams();
            params.append('operation', 'add_blocked_domain');
            params.append('domain', domain);
            params.append('action', 'add_blocked_domain');
            params.append('redirect_tab', 'settings');
            
            window.location.href = `/admin/confirm-password?${params.toString()}`;
        }

        function clearOldTrash() {
            performMaintenanceWithConfirmation('clear_old_trash', 'Clear Expired Trash');
        }

        function resetSystemSettings() {
            const confirmMessage = `WARNING: This will reset ALL system settings to defaults!\n\nThis action cannot be undone. You will be asked to enter your administrator password for security verification.\n\nAre you sure you want to continue?`;
            if (confirm(confirmMessage)) {
                window.location.href = `/admin/confirm-password?operation=reset_system_settings`;
            }
        }

        // Keep all other existing functions (filterUsers, filterDatabases, etc.)
        function filterUsers() {
            const searchInput = document.getElementById('user-search').value.toLowerCase();
            const roleFilter = document.getElementById('role-filter').value;
            const rows = document.querySelectorAll('.user-row');
            
            rows.forEach(row => {
                const username = row.getAttribute('data-username');
                const email = row.getAttribute('data-email');
                const role = row.getAttribute('data-role');
                
                const matchesSearch = username.includes(searchInput) || email.includes(searchInput);
                const matchesRole = !roleFilter || role === roleFilter;
                
                if (matchesSearch && matchesRole) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        }

        function filterDatabases() {
            const searchInput = document.getElementById('database-search').value.toLowerCase();
            const statusFilter = document.getElementById('status-filter').value;
            const ownerFilter = document.getElementById('owner-filter').value.toLowerCase();
            const rows = document.querySelectorAll('.database-row');
            
            rows.forEach(row => {
                const dbName = row.getAttribute('data-name');
                const status = row.getAttribute('data-status');
                const owner = row.getAttribute('data-owner');
                
                const matchesSearch = dbName.includes(searchInput) || owner.includes(searchInput);
                const matchesStatus = !statusFilter || status === statusFilter;
                const matchesOwner = !ownerFilter || owner === ownerFilter;
                
                if (matchesSearch && matchesStatus && matchesOwner) {
                    row.style.display = '';
                    // Also show the corresponding details row if it exists but keep it hidden
                    const dbId = row.querySelector('button[onclick*="toggleDatabaseDetails"]')?.onclick.toString().match(/'([^']+)'/)?.[1];
                    if (dbId) {
                        const detailsRow = document.getElementById(`details-${dbId}`);
                        if (detailsRow && !detailsRow.classList.contains('hidden')) {
                            detailsRow.style.display = '';
                        }
                    }
                } else {
                    row.style.display = 'none';
                    // Also hide the corresponding details row
                    const dbId = row.querySelector('button[onclick*="toggleDatabaseDetails"]')?.onclick.toString().match(/'([^']+)'/)?.[1];
                    if (dbId) {
                        const detailsRow = document.getElementById(`details-${dbId}`);
                        if (detailsRow) {
                            detailsRow.style.display = 'none';
                        }
                    }
                }
            });
        }

        function filterActivity() {
            const filter = document.getElementById('activity-filter').value;
            const logs = document.querySelectorAll('.activity-log');
            
            logs.forEach(log => {
                if (!filter || log.getAttribute('data-action') === filter) {
                    log.style.display = '';
                } else {
                    log.style.display = 'none';
                }
            });
        }

        function toggleDatabaseDetails(dbId) {
            const detailsRow = document.getElementById(`details-${dbId}`);
            const button = event.target.closest('button');
            const icon = button.querySelector('i');
            
            if (detailsRow.classList.contains('hidden')) {
                detailsRow.classList.remove('hidden');
                detailsRow.style.display = ''; // Ensure it's visible
                icon.className = 'ri-eye-off-line mr-1';
                button.innerHTML = '<i class="ri-eye-off-line mr-1"></i>Hide Details';
            } else {
                detailsRow.classList.add('hidden');
                detailsRow.style.display = 'none'; // Ensure it's hidden
                icon.className = 'ri-eye-line mr-1';
                button.innerHTML = '<i class="ri-eye-line mr-1"></i>View Details';
            }
        }

        function editUserRole(userId, username, currentRole) {
            document.getElementById('edit-user-id').value = userId;
            document.getElementById('edit-username').value = username;
            document.getElementById('edit-role').value = currentRole;
            document.getElementById('edit-user-modal').classList.remove('hidden');
        }

        function closeEditModal() {
            document.getElementById('edit-user-modal').classList.add('hidden');
        }

        function resetUserPassword(userId, username) {
            // Show confirmation dialog first
            const confirmMessage = `Reset password for user "${username}"?\n\nThis will:\n• Generate a temporary password\n• Force the user to change password on next login\n• Log this administrative action\n\nYou will be asked to confirm with your administrator password.`;
            
            if (confirm(confirmMessage)) {
                // Open the reset password modal for password generation
                document.getElementById('reset-user-id').value = userId;
                document.getElementById('reset-username').value = username;
                document.getElementById('temp-password').value = '';
                document.getElementById('confirm-reset-btn').disabled = true;
                document.getElementById('reset-password-modal').classList.remove('hidden');
                
                // Auto-generate a temporary password
                generateTempPassword();
            }
        }

        function confirmResetPassword() {
            // This function is called when the reset password form is submitted
            // Collect the form data and redirect to confirmation page
            const userId = document.getElementById('reset-user-id').value;
            const tempPassword = document.getElementById('temp-password').value;
            const username = document.getElementById('reset-username').value;
            
            if (!tempPassword) {
                alert('Please generate a temporary password first.');
                return;
            }
            
            // Close the modal
            closeResetModal();
            
            // Redirect to confirmation page with form data
            const params = new URLSearchParams();
            params.append('operation', 'reset_user_password');
            params.append('user_id', userId);
            params.append('temp_password', tempPassword);
            params.append('username', username);
            
            window.location.href = `/admin/confirm-password?${params.toString()}`;
        }

        function deleteUser(userId, username) {
            // Enhanced confirmation dialog
            const confirmMessage = `WARNING: Delete user account "${username}"?\n\nThis action will:\n• Permanently remove the user from the system\n• Remove their access to all databases\n• This action CANNOT be undone\n\nYou will be asked to confirm with your administrator password.\n\nAre you absolutely sure?`;
            
            if (confirm(confirmMessage)) {
                // Redirect to confirmation page with delete user data
                const params = new URLSearchParams();
                params.append('operation', 'delete_user');
                params.append('user_id', userId);
                params.append('username', username);
                
                window.location.href = `/admin/confirm-password?${params.toString()}`;
            }
        }

        // Update the existing modal functions
        function closeResetModal() {
            document.getElementById('reset-password-modal').classList.add('hidden');
            document.getElementById('temp-password').value = '';
            document.getElementById('confirm-reset-btn').disabled = true;
        }

        function generateTempPassword() {
            // Generate a secure temporary password
            const chars = 'abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789!@#$%^&*';
            let tempPassword = '';
            
            // Ensure at least one of each type
            tempPassword += 'abcdefghijklmnopqrstuvwxyz'[Math.floor(Math.random() * 26)]; // lowercase
            tempPassword += 'ABCDEFGHIJKLMNOPQRSTUVWXYZ'[Math.floor(Math.random() * 26)]; // uppercase
            tempPassword += '0123456789'[Math.floor(Math.random() * 10)]; // number
            tempPassword += '!@#$%^&*'[Math.floor(Math.random() * 8)]; // special char
            
            // Fill the rest randomly
            for (let i = 4; i < 12; i++) {
                tempPassword += chars[Math.floor(Math.random() * chars.length)];
            }
            
            // Shuffle the password
            tempPassword = tempPassword.split('').sort(() => 0.5 - Math.random()).join('');
            
            document.getElementById('temp-password').value = tempPassword;
            document.getElementById('confirm-reset-btn').disabled = false;
        }

        function copyTempPassword() {
            const tempPasswordField = document.getElementById('temp-password');
            const tempPassword = tempPasswordField.value;
            
            if (!tempPassword) {
                alert('Please generate a temporary password first.');
                return;
            }
            
            // Copy to clipboard
            navigator.clipboard.writeText(tempPassword).then(function() {
                // Visual feedback
                const button = event.target.closest('button');
                const originalText = button.innerHTML;
                button.innerHTML = '<i class="ri-check-line mr-1"></i>Copied!';
                button.classList.remove('bg-gray-500', 'hover:bg-gray-600');
                button.classList.add('bg-green-500', 'hover:bg-green-600');
                
                setTimeout(() => {
                    button.innerHTML = originalText;
                    button.classList.remove('bg-green-500', 'hover:bg-green-600');
                    button.classList.add('bg-gray-500', 'hover:bg-gray-600');
                }, 2000);
                
                // Show success message
                alert('Temporary password copied to clipboard!\n\nMake sure to securely share this with the user.');
            }).catch(function(err) {
                console.error('Failed to copy text: ', err);
                // Fallback for older browsers
                tempPasswordField.select();
                tempPasswordField.setSelectionRange(0, 99999);
                document.execCommand("copy");
                alert('Temporary password copied to clipboard!');
            });
        }

        // Close reset modal when clicking outside
        document.addEventListener('DOMContentLoaded', function() {
            const resetModal = document.getElementById('reset-password-modal');
            if (resetModal) {
                resetModal.addEventListener('click', function(e) {
                    if (e.target === this) {
                        closeResetModal();
                    }
                });
            }
        });


        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            // Check if we should show the settings tab (from URL parameter or redirect)
            const urlParams = new URLSearchParams(window.location.search);
            const tab = urlParams.get('tab');
            
            if (tab === 'settings') {
                showTab('settings');
            } else {
                showTab('databases');
            }
            
            // Fix any display issues after page load
            setTimeout(() => {
                const rows = document.querySelectorAll('.database-row');
                rows.forEach(row => {
                    if (row.style.display === 'none') {
                        // Check if this row should be visible based on current filter
                        const filter = document.getElementById('status-filter').value;
                        if (!filter || row.getAttribute('data-status') === filter) {
                            row.style.display = '';
                        }
                    }
                });
            }, 100);
        });

        // Close modals when clicking outside
        document.addEventListener('DOMContentLoaded', function() {
            const editModal = document.getElementById('edit-user-modal');
            if (editModal) {
                editModal.addEventListener('click', function(e) {
                    if (e.target === this) {
                        closeEditModal();
                    }
                });
            }
        });
    </script>

    <!-- STYLE SECTION -->
    <style>
        .tab-button.active {
            border-bottom: 2px solid theme('colors.accent');
        }
        .tab-button:not(.active) {
            border-bottom: 2px solid transparent;
        }

        /* Spinner animation for loading states */
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        .animate-spin {
            animation: spin 1s linear infinite;
        }

        /* Modal backdrop styling */
        .modal-backdrop {
            backdrop-filter: blur(2px);
        }

        /* Password modal specific styling */
        #admin-password-modal .bg-white {
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
        }

        /* Focus states for better accessibility */
        #admin-password-input:focus {
            box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.1);
        }

        /* Button hover effects */
        button:hover:not(:disabled) {
            transform: translateY(-1px);
            transition: transform 0.2s ease;
        }

        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        /* Success/Error message styling */
        .success-message {
            animation: slideIn 0.3s ease-out;
        }

        .error-message {
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Table hover effects */
        .database-row:hover,
        .user-row:hover {
            background-color: rgba(59, 130, 246, 0.05);
            transition: background-color 0.2s ease;
        }

        /* Card hover effects for statistics */
        .transform:hover {
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            .grid.grid-cols-4 {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .w-\\[90\\%\\] {
                width: 95%;
            }
        }

        @media (max-width: 640px) {
            .grid.grid-cols-4 {
                grid-template-columns: 1fr;
            }
            
            .flex.gap-3 {
                flex-direction: column;
            }
            
            .flex.gap-2 {
                flex-direction: column;
            }
        }
    </style>
</body>
</html>