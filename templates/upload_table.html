<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=0.9">
    <meta name="robots" content="noindex">
    <title>My Databases - {{ content.title.content | default("Resette Portal") }}</title>
    <script src="https://cdn.tailwindcss.com/3.4.16"></script>
    <script src="/static/js/tailwind.config.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/remixicon/4.6.0/remixicon.min.css">
    <link rel="stylesheet" href="/static/styles.css">
    <link rel="icon" href="/static/favicon.ico">
    <style>
        .upload-tab.active {
            border-bottom: 2px solid #3b82f6;
        }
        .upload-tab:not(.active) {
            border-bottom: 2px solid transparent;
        }
        
        .animate-spin {
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        @keyframes pulse-gradient {
            0% { background-position: 200% 0; opacity: 0.6; }
            50% { background-position: 0% 0; opacity: 1; }
            100% { background-position: -200% 0; opacity: 0.6; }
        }

        .progress-pulse {
            background: linear-gradient(90deg, #3b82f6, #1d4ed8, #3b82f6);
            background-size: 200% 100%;
            animation: pulse-gradient 2s ease-in-out infinite;
        }

        button:disabled {
            transform: none !important;
        }
        
        #upload-progress-overlay {
            backdrop-filter: blur(4px);
        }

        .error-details {
            max-height: 120px;
            overflow-y: auto;
        }
    </style>
</head>
<body class="bg-gray-50">
    <header class="fixed top-0 left-0 right-0 z-50 bg-header text-white shadow-md">
        <div class="container mx-auto px-4 h-20 flex items-center justify-between">
            <div class="flex items-center">
                <div class="w-10 h-10 flex items-center justify-center mr-3">
                    <i class="ri-upload-cloud-line text-white ri-2x" aria-hidden="true"></i>
                </div>
                <div class="text-xl font-semibold">Upload Data to {{ db_name.replace('_', ' ').title() }}</div>
            </div>
            <div>
                <a href="/manage-databases" class="text-white hover:text-accent mr-4">
                    <i class="ri-arrow-left-line mr-1"></i>Back to Databases
                </a>
                <a href="/logout" class="text-white hover:text-accent">Logout</a>
            </div>
        </div>
    </header>
    
    <!-- Progress overlay (z-60) -->
    <div id="upload-progress-overlay" class="hidden fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-60">
        <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4 shadow-2xl">
            <div class="text-center">
                <!-- Status Icon -->
                <div class="mb-4">
                    <i id="progress-icon" class="ri-upload-cloud-line text-5xl text-blue-500"></i>
                </div>

                <!-- Title and Message -->
                <h3 class="text-lg font-semibold mb-2" id="progress-title">Processing Upload...</h3>
                <p class="text-gray-600 text-sm mb-4" id="progress-message">Please wait while your data is being processed.</p>
                
                <!-- Simple Progress Spinner -->
                <div class="mb-4" id="progress-section">
                    <div class="w-full bg-gray-200 rounded-full h-3 mb-3">
                        <div id="progress-bar" class="bg-blue-500 h-3 rounded-full transition-all duration-300 ease-out progress-pulse" style="width: 100%"></div>
                    </div>
                    
                    <!-- Enhanced progress info that adapts to upload type -->
                    <div id="progress-time" class="text-xs text-gray-500 text-center">
                        Elapsed: 0s
                    </div>
                </div>
                
                <!-- Upload Details (only for file uploads) -->
                <div id="upload-details" class="text-xs text-gray-600 mb-4 hidden">
                    <div class="flex justify-between">
                        <span>File:</span>
                        <span id="upload-filename"></span>
                    </div>
                    <div class="flex justify-between">
                        <span>Size:</span>
                        <span id="upload-filesize"></span>
                    </div>
                    <div class="flex justify-between">
                        <span>Status:</span>
                        <span id="upload-status">Uploading...</span>
                    </div>
                </div>
                
                <!-- Action Buttons -->
                <div id="action-buttons" class="space-y-2">
                    <button id="cancel-upload-btn" class="w-full bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600 transition text-sm">
                        <i class="ri-close-line mr-1"></i>Cancel Upload
                    </button>
                </div>
                
                <!-- Result Display -->
                <div id="upload-result" class="hidden mt-4">
                    <div id="upload-result-content" class="p-4 rounded-lg"></div>
                    <div id="result-actions" class="mt-3 space-y-2">
                        <button id="close-result-btn" class="w-full bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600 transition text-sm">
                            Close
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <main class="flex-grow pt-20 pb-6">
        <section class="container mx-auto px-4 mt-6">
            <div class="max-w-4xl mx-auto">
                <!-- Header -->
                <div class="text-center mb-8">
                    <h1 class="text-3xl font-bold text-primary mb-4">Upload Data</h1>
                    <p class="text-gray-600">Add table to your {{ db_name.replace('_', ' ').title() }} database from multiple sources</p>
                </div>

                <!-- Enhanced Error/Success Messages -->
                <div id="message-container" class="mb-6">
                    <!-- Dynamic messages will be inserted here -->
                </div>

                <!-- Upload Tabs -->
                <div class="bg-white rounded-lg border border-gray-200 shadow-sm mb-6">
                    <div class="border-b border-gray-200">
                        <nav class="flex">
                            <button onclick="switchUploadTab('file')" id="file-tab" 
                                    class="upload-tab active px-6 py-4 font-medium text-blue-600 border-b-2 border-blue-600">
                                <i class="ri-file-upload-line mr-2"></i>Upload File
                            </button>
                            <button onclick="switchUploadTab('sheets')" id="sheets-tab" 
                                    class="upload-tab px-6 py-4 font-medium text-gray-500 hover:text-blue-600">
                                <i class="ri-table-line mr-2"></i>Google Sheets
                            </button>
                            <button onclick="switchUploadTab('url')" id="url-tab" 
                                    class="upload-tab px-6 py-4 font-medium text-gray-500 hover:text-blue-600">
                                <i class="ri-global-line mr-2"></i>Web CSV
                            </button>
                        </nav>
                    </div>

                    <!-- File Upload Panel -->
                    <div id="file-panel" class="upload-panel p-6">
                        <form id="file-upload-form" onsubmit="return handleFileUpload(event)">
                            <input type="hidden" name="csrftoken" value="{{ csrftoken() }}">
                            <input type="hidden" name="source_type" value="file">
                            
                            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                                <!-- File Selection with Enhanced Validation -->
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">
                                        Select File
                                    </label>
                                    <div class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center hover:border-blue-400 transition"
                                        ondragover="handleDragOver(event)"
                                        ondrop="handleDrop(event)"
                                        ondragleave="handleDragLeave(event)">
                                        <input type="file" name="file" id="file-input" 
                                            accept="{{ system_settings.allowed_extensions }}" 
                                            class="hidden" onchange="handleFileSelect(this)">
                                        <label for="file-input" class="cursor-pointer">
                                            <i class="ri-upload-cloud-2-line text-4xl text-gray-400 mb-2 block"></i>
                                            <p class="text-gray-600">Click to select file or drag & drop</p>
                                            <p class="text-xs text-gray-500 mt-1">Supports: {{ system_settings.allowed_extensions.replace(',', ', ') }} up to {{ (system_settings.max_file_size // (1024*1024)) }}MB</p>
                                        </label>
                                    </div>

                                    <div class="text-xs text-gray-500 mt-2">
                                        <div class="font-semibold text-blue-600 mt-4">Null Value Options</div>
                                        <ul class="space-y-1">
                                            <li>• Empty strings: Best for most uses</li>
                                            <li>• Preserve NULLs: For advanced analysis</li>
                                            <li>• Skip empty rows: Clean data import</li>
                                            <li>• Handles: NULL, N/A, blank cells</li>
                                        </ul>
                                    </div>

                                    <!-- Enhanced File Info Display -->
                                    <div id="file-info" class="hidden mt-4">
                                        <div id="file-details" class="p-3 bg-blue-50 rounded border"></div>
                                        <div id="file-warnings" class="hidden mt-2 p-3 bg-yellow-50 border border-yellow-200 rounded">
                                            <div class="text-sm text-yellow-800"></div>
                                        </div>
                                        <div id="file-errors" class="hidden mt-2 p-3 bg-red-50 border border-red-200 rounded">
                                            <div class="text-sm text-red-800"></div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Upload Options -->
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">
                                        Table Name (Optional)
                                    </label>
                                    <input type="text" name="table_name" id="table-name" 
                                        class="w-full p-3 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500"
                                        placeholder="Auto-generated from filename">
                                    <p class="text-xs text-gray-500 mt-1">Leave blank to use filename. Must be unique in database.</p>

                                    <div class="mt-4">
                                        <label class="flex items-center">
                                            <input type="checkbox" name="replace_existing" class="mr-2">
                                            <span class="text-sm text-gray-700">Replace existing table if name conflicts</span>
                                        </label>
                                    </div>

                                    <div class="mt-4">
                                        <label class="block text-sm font-medium text-gray-700 mb-2">
                                            Null Value Handling
                                        </label>
                                        <select name="null_handling" class="w-full p-3 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500">
                                            <option value="empty_string">Convert nulls to empty strings (recommended)</option>
                                            <option value="preserve">Preserve as NULL values in database</option>
                                            <option value="skip_rows">Skip rows with excessive nulls (>80%)</option>
                                        </select>
                                        <p class="text-xs text-gray-500 mt-1">
                                            How to handle empty cells, "NULL", "N/A", etc. in your data
                                        </p>
                                    </div>

                                    <div class="mt-6">
                                        <button type="submit" id="file-upload-btn"
                                                class="w-full bg-blue-600 text-white py-3 px-4 rounded hover:bg-blue-700 transition font-medium disabled:bg-gray-400"
                                                disabled>
                                            <i class="ri-upload-line mr-2" id="file-upload-icon"></i>
                                            <span id="file-upload-text">Select a file to upload</span>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </form>
                    </div>

                    <!-- Google Sheets Panel -->
                    <div id="sheets-panel" class="upload-panel p-6 hidden">
                        <form id="sheets-upload-form" onsubmit="return handleSheetsUpload(event)">
                            <input type="hidden" name="csrftoken" value="{{ csrftoken() }}">
                            <input type="hidden" name="source_type" value="sheets">
                            
                            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                                <!-- Google Sheets URL -->
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">
                                        Google Sheets URL
                                    </label>
                                    <input type="url" name="sheets_url" id="sheets-url" 
                                        class="w-full p-3 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500"
                                        placeholder="https://docs.google.com/spreadsheets/d/..."
                                        onblur="validateSheetsUrl()">
                                    
                                    <div class="text-xs text-gray-500 mt-1">
                                        <p><strong>Important:</strong> The sheet must be publicly accessible.</p>
                                        <details class="mt-2">
                                            <summary class="cursor-pointer text-blue-600 hover:text-blue-800">How to share your sheet</summary>
                                            <ol class="list-decimal list-inside mt-1 space-y-1">
                                                <li>Open your Google Sheet</li>
                                                <li>Click "Share" (top right)</li>
                                                <li>Change to "Anyone with the link can view"</li>
                                                <li>Copy the link and paste it here</li>
                                            </ol>
                                        </details>
                                    
                                        <div>
                                            <div class="font-semibold text-blue-600 mt-4">Null Value Options</div>
                                            <ul class="space-y-1">
                                                <li>• Empty strings: Best for most uses</li>
                                                <li>• Preserve NULLs: For advanced analysis</li>
                                                <li>• Skip empty rows: Clean data import</li>
                                                <li>• Handles: NULL, N/A, blank cells</li>
                                            </ul>
                                        </div>
                                    </div>
                                    <!-- Sheet Validation -->
                                    <div id="sheets-validation" class="hidden mt-3">
                                        <div id="sheets-validation-content" class="p-3 rounded border"></div>
                                    </div>
                                </div>

                                <!-- Import Options -->
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">
                                        Table Name (Optional)
                                    </label>
                                    <input type="text" name="table_name" id="sheets-table-name" 
                                        class="w-full p-3 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500"
                                        placeholder="Auto-generated from sheet name">

                                    <div class="mt-4">
                                        <label class="flex items-center">
                                            <input type="checkbox" name="first_row_headers" checked class="mr-2">
                                            <span class="text-sm text-gray-700">First row contains headers</span>
                                        </label>
                                    </div>

                                    <div class="mt-2">
                                        <label class="flex items-center">
                                            <input type="checkbox" name="replace_existing" class="mr-2">
                                            <span class="text-sm text-gray-700">Replace existing table if name conflicts</span>
                                        </label>
                                    </div>

                                    <div class="mt-4">
                                        <label class="block text-sm font-medium text-gray-700 mb-2">
                                            Null Value Handling
                                        </label>
                                        <select name="null_handling" class="w-full p-3 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500">
                                            <option value="empty_string">Convert nulls to empty strings (recommended)</option>
                                            <option value="preserve">Preserve as NULL values in database</option>
                                            <option value="skip_rows">Skip rows with excessive nulls (>80%)</option>
                                        </select>
                                        <p class="text-xs text-gray-500 mt-1">
                                            How to handle empty cells and null values from Google Sheets
                                        </p>
                                    </div>

                                    <div class="mt-6">
                                        <button type="submit" id="sheets-upload-btn"
                                                class="w-full bg-blue-600 text-white py-3 px-4 rounded hover:bg-blue-700 transition font-medium">
                                            <i class="ri-download-cloud-line mr-2" id="sheets-upload-icon"></i>
                                            <span id="sheets-upload-text">Import from Google Sheets</span>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </form>
                    </div>

                    <!-- Web CSV Panel -->
                    <div id="url-panel" class="upload-panel p-6 hidden">
                        <form id="url-upload-form" onsubmit="return handleUrlUpload(event)">
                            <input type="hidden" name="csrftoken" value="{{ csrftoken() }}">
                            <input type="hidden" name="source_type" value="url">
                            
                            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                                <!-- URL Input -->
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">
                                        CSV File URL
                                    </label>
                                    <input type="url" name="csv_url" id="csv-url" 
                                        class="w-full p-3 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500"
                                        placeholder="https://example.com/data.csv"
                                        onblur="validateCsvUrl()">
                                    
                                    <div class="text-xs text-gray-500 mt-1">
                                        <p><strong>Supported:</strong> Most domains are allowed unless blocked by admin.</p>
                                        <p class="mt-1">URL must point directly to a CSV file. Raw URLs work best.</p>
                                        <p class="mt-1">Contact admin if your domain is blocked.</p>
                                    </div>

                                    <div class="text-xs text-gray-500 mt-2">
                                        <div class="font-semibold text-blue-600 mt-4">Null Value Options</div>
                                        <ul class="space-y-1">
                                            <li>• Empty strings: Best for most uses</li>
                                            <li>• Preserve NULLs: For advanced analysis</li>
                                            <li>• Skip empty rows: Clean data import</li>
                                            <li>• Handles: NULL, N/A, blank cells</li>
                                        </ul>
                                    </div>
                                    <!-- URL Validation -->
                                    <div id="url-validation" class="hidden mt-3">
                                        <div id="url-validation-content" class="p-3 rounded border"></div>
                                    </div>
                                </div>

                                <!-- Import Options -->
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">
                                        Table Name (Optional)
                                    </label>
                                    <input type="text" name="table_name" id="url-table-name" 
                                        class="w-full p-3 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500"
                                        placeholder="Auto-generated from URL">

                                    <div class="mt-4">
                                        <label class="block text-sm font-medium text-gray-700 mb-2">
                                            Encoding
                                        </label>
                                        <select name="encoding" class="w-full p-3 border border-gray-300 rounded">
                                            <option value="auto">Auto-detect</option>
                                            <option value="utf-8">UTF-8</option>
                                            <option value="latin-1">Latin-1</option>
                                            <option value="ascii">ASCII</option>
                                        </select>
                                    </div>

                                    <div class="mt-4">
                                        <label class="flex items-center">
                                            <input type="checkbox" name="replace_existing" class="mr-2">
                                            <span class="text-sm text-gray-700">Replace existing table if name conflicts</span>
                                        </label>
                                    </div>

                                    <div class="mt-4">
                                        <label class="block text-sm font-medium text-gray-700 mb-2">
                                            Null Value Handling
                                        </label>
                                        <select name="null_handling" class="w-full p-3 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500">
                                            <option value="empty_string">Convert nulls to empty strings (recommended)</option>
                                            <option value="preserve">Preserve as NULL values in database</option>
                                            <option value="skip_rows">Skip rows with excessive nulls (>80%)</option>
                                        </select>
                                        <p class="text-xs text-gray-500 mt-1">
                                            How to handle empty cells and null-like values in CSV data
                                        </p>
                                    </div>

                                    <div class="mt-6">
                                        <button type="submit" id="url-upload-btn"
                                                class="w-full bg-blue-600 text-white py-3 px-4 rounded hover:bg-blue-700 transition font-medium">
                                            <i class="ri-download-line mr-2" id="url-upload-icon"></i>
                                            <span id="url-upload-text">Import from URL</span>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- Enhanced Help Section -->
                <div class="bg-blue-50 border border-blue-200 rounded-card p-6 mt-6">
                    <h3 class="text-lg font-semibold text-blue-800 mb-4">
                        <i class="ri-information-line mr-2"></i>Upload Guidelines & Troubleshooting
                    </h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-sm text-blue-700">
                        <div>
                            <div class="font-semibold text-blue-800 mb-2">File Uploads</div>
                            <ul class="space-y-1">
                                <li>• Supported formats: CSV, TSV, TXT</li>
                                <li>• Excel files: .xlsx, .xls</li>
                                <li>• JSON Lines files: .jsonl, .json</li>
                                <li>• UTF-8 encoding recommended</li>
                                <li>• First row should contain headers (CSV/Excel)</li>
                                <li>• One JSON object per line (JSONL)</li>
                                <li>• Maximum size: {{ (system_settings.max_file_size // (1024*1024)) }}MB</li>
                            </ul>
                        </div>
                        <div>
                            <div class="font-semibold text-blue-800 mb-2">Google Sheets</div>
                            <ul class="space-y-1">
                                <li>• Sheet must be publicly accessible</li>
                                <li>• Use "Anyone with link sharin"</li>
                                <li>• Automatically detects data ranges</li>
                                <li>• First sheet only will be imported</li>
                                <li>• Maximum size: {{ (system_settings.max_file_size // (1024*1024)) }}MB</li>
                            </ul>
                        </div>
                        <div>
                            <div class="font-semibold text-blue-800 mb-2">Web CSV</div>
                            <ul class="space-y-1">
                                <li>• Most domains are supported</li>
                                <li>• Must point directly to CSV file</li>
                                <li>• Raw URLs work best</li>
                                <li>• Some domains may be blocked by admin</li>
                                <li>• Maximum size: {{ (system_settings.max_file_size // (1024*1024)) }}MB</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <script>
        // Enhanced Upload Manager with Server-Driven Configuration
        class EnhancedUploadManager {
            constructor() {
                this.currentXHR = null;
                this.startTime = null;
                this.progressTimer = null;
                this.isUploading = false;
                this.currentUploadId = null;
                this.abortController = null;
                this.isCancelling = false;
                this.cancelRequested = false;
                this.maxFileSize = {{ system_settings.max_file_size }}; // Server-rendered value in bytes
                this.lastProgressUpdate = 0;
                this.uploadStartTime = null;
                this.lastProgressTime = 0;
                this.uploadSpeed = 0;
                this.totalFileSize = 0;
            }

            getDbNameFromUrl() {
                // Extract database name from current URL path
                const pathParts = window.location.pathname.split('/');
                const uploadIndex = pathParts.indexOf('upload-table');
                if (uploadIndex !== -1 && pathParts[uploadIndex + 1]) {
                    return pathParts[uploadIndex + 1];
                }
                return null;
            }

            getCsrfToken() {
                // Priority order: form input, then meta tag
                const csrfInput = document.querySelector('input[name="csrftoken"]');
                if (csrfInput && csrfInput.value) {
                    return csrfInput.value;
                }
                
                const csrfMeta = document.querySelector('meta[name="csrf-token"]');
                if (csrfMeta) {
                    return csrfMeta.getAttribute('content');
                }
                
                console.warn('No CSRF token found');
                return '';
            }

            generateUploadId(type) {
                const timestamp = Date.now();
                const random = Math.random().toString(36).substr(2, 9);
                return `upload_${type}_${timestamp}_${random}`;
            }

            clearAllMessages() {
                const container = document.getElementById('message-container');
                container.innerHTML = '';
            }

            showMessage(message, type = 'info', details = null) {
                this.clearAllMessages();
                const container = document.getElementById('message-container');
                
                const colors = {
                    success: 'bg-green-100 border-green-400 text-green-700',
                    error: 'bg-red-100 border-red-400 text-red-700',
                    warning: 'bg-yellow-100 border-yellow-400 text-yellow-700',
                    info: 'bg-blue-100 border-blue-400 text-blue-700'
                };

                const icons = {
                    success: 'ri-check-circle-line',
                    error: 'ri-error-warning-line',
                    warning: 'ri-alert-line',
                    info: 'ri-information-line'
                };

                let html = `
                    <div class="border px-4 py-3 rounded-lg ${colors[type]}">
                        <div class="flex items-start">
                            <i class="${icons[type]} text-lg mr-2 mt-0.5"></i>
                            <div class="flex-1">
                                <div class="font-medium">${message}</div>
                `;

                if (details) {
                    html += `
                        <div class="mt-2 text-sm error-details">
                            ${details}
                        </div>
                    `;
                }

                html += `
                            </div>
                            <button onclick="uploadManager.clearAllMessages()" class="ml-2 text-lg hover:opacity-70">
                                <i class="ri-close-line"></i>
                            </button>
                        </div>
                    </div>
                `;

                container.innerHTML = html;
            }

            validateFileSize(file) {
                // Account for ~15% multipart encoding overhead
                const multipartOverhead = file.size * 0.15;
                const totalSize = file.size + multipartOverhead;
                
                if (totalSize > this.maxFileSize) {
                    const fileSizeMB = (file.size / (1024 * 1024)).toFixed(1);
                    const maxSizeMB = Math.floor(this.maxFileSize / (1024 * 1024));
                    
                    const errorMsg = `File size (${fileSizeMB}MB) may exceed the ${maxSizeMB}MB limit after encoding`;
                    const details = `
                        <strong>What you can try:</strong>
                        <ul class="list-disc list-inside mt-1 space-y-1">
                            <li>Use a file smaller than ${Math.floor(maxSizeMB * 0.85)}MB to be safe</li>
                            <li>Reduce the number of rows in your file</li>
                            <li>Remove unnecessary columns</li>
                            <li>For Excel files, save as CSV to reduce size</li>
                        </ul>
                    `;
                    
                    this.showMessage(errorMsg, 'error', details);
                    return false;
                }
                return true;
            }

            validateFileType(file) {
                const fileName = file.name.toLowerCase();
                const fileExt = '.' + fileName.split('.').pop().toLowerCase();
                
                const allowedExtensionsString = "{{ system_settings.allowed_extensions | e }}";
                const allowedExtensions = allowedExtensionsString.split(',')
                    .map(ext => ext.trim().toLowerCase())
                    .map(ext => ext.startsWith('.') ? ext : '.' + ext); // Ensure all have dots
                
                const isValid = allowedExtensions.includes(fileExt);
                
                if (!isValid) {
                    const allowedDisplay = allowedExtensions.map(ext => ext.toUpperCase());
                    const errorMsg = `File type '${fileExt.toUpperCase()}' is not supported`;
                    const details = `
                        <strong>Supported file types:</strong>
                        <ul class="list-disc list-inside mt-1">
                            ${allowedDisplay.map(ext => `<li>${ext} files</li>`).join('')}
                        </ul>
                    `;
                    this.showMessage(errorMsg, 'error', details);
                    return false;
                }
                return true;
            }

            showProgress(title, message, type = 'file', filename = '', filesize = '') {
                this.clearAllMessages();
                
                const overlay = document.getElementById('upload-progress-overlay');
                const progressTitle = document.getElementById('progress-title');
                const progressMessage = document.getElementById('progress-message');
                const progressIcon = document.getElementById('progress-icon');
                const uploadDetails = document.getElementById('upload-details');
                const uploadFilename = document.getElementById('upload-filename');
                const uploadFilesize = document.getElementById('upload-filesize');
                const uploadResult = document.getElementById('upload-result');
                const cancelButton = document.getElementById('cancel-upload-btn');
                const actionButtons = document.getElementById('action-buttons');
                const progressSection = document.getElementById('progress-section');

                // Set content
                progressTitle.textContent = title;
                progressMessage.textContent = message;
                
                // Set appropriate icon
                const iconClass = type === 'sheets' ? 'ri-table-line' : 
                                type === 'url' ? 'ri-global-line' : 'ri-upload-cloud-line';
                progressIcon.className = `${iconClass} text-5xl text-blue-500`;
                
                // Show file details for file uploads
                if (filename && filesize && type === 'file') {
                    uploadFilename.textContent = filename;
                    uploadFilesize.textContent = filesize;
                    uploadDetails.classList.remove('hidden');
                    
                    // Parse file size for progress calculations
                    const sizeInBytes = this.parseFileSizeToBytes(filesize);
                    this.totalFileSize = sizeInBytes;
                } else {
                    uploadDetails.classList.add('hidden');
                    this.totalFileSize = 0;
                }
                
                // Reset states
                this.resetProgress(type);
                uploadResult.classList.add('hidden');
                actionButtons.classList.remove('hidden');
                progressSection.classList.remove('hidden');
                this.isCancelling = false;
                this.cancelRequested = false;
                this.uploadStartTime = Date.now();
                
                // Reset cancel button
                if (cancelButton) {
                    cancelButton.classList.remove('hidden');
                    cancelButton.disabled = false;
                    cancelButton.innerHTML = '<i class="ri-close-line mr-1"></i>Cancel Upload';
                    cancelButton.className = 'w-full bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600 transition text-sm';
                }
                
                // Show overlay
                overlay.classList.remove('hidden');
                this.isUploading = true;
                this.startTime = Date.now();
                this.startTimer();
            }

            hideProgress() {
                const overlay = document.getElementById('upload-progress-overlay');
                overlay.classList.add('hidden');
                
                // Clear timers
                if (this.progressTimer) {
                    clearInterval(this.progressTimer);
                    this.progressTimer = null;
                }
                
                // Reset states
                this.isUploading = false;
                this.isCancelling = false;
                this.cancelRequested = false;
                this.currentXHR = null;
                this.currentUploadId = null;
                this.abortController = null;
                this.startTime = null;
                this.uploadStartTime = null;
                this.lastProgressTime = 0;
                this.uploadSpeed = 0;
                this.totalFileSize = 0;
            }
            
            // Enhanced progress reset with different behavior for file uploads
            resetProgress(type = 'file') {
                const progressBar = document.getElementById('progress-bar');
                const progressTime = document.getElementById('progress-time');
                
                if (progressBar) {
                    if (type === 'file') {
                        // For file uploads, start at 0% and show actual progress
                        progressBar.style.width = '0%';
                        progressBar.className = 'bg-blue-500 h-3 rounded-full transition-all duration-300 ease-out';
                    } else {
                        // For sheets/URL, use indeterminate progress
                        progressBar.style.width = '100%';
                        progressBar.className = 'bg-blue-500 h-3 rounded-full transition-all duration-300 ease-out progress-pulse';
                    }
                }
                
                if (progressTime) {
                    progressTime.textContent = 'Elapsed: 0s';
                }
            }
            
            // Enhanced progress update with detailed file upload information
            updateProgress(loaded, total) {
                if (!this.isUploading || this.isCancelling) return;
                
                // Only show detailed progress for file uploads with actual progress data
                if (!loaded || !total || loaded === 0 || total === 0) {
                    return;
                }

                const now = Date.now();
                const percentage = Math.round((loaded / total) * 100);
                const progressBar = document.getElementById('progress-bar');
                const progressTime = document.getElementById('progress-time');
                
                // Update progress bar
                if (progressBar) {
                    progressBar.style.width = percentage + '%';
                    progressBar.className = 'bg-blue-500 h-3 rounded-full transition-all duration-300 ease-out';
                }
                
                // Calculate upload speed and ETA (update every 2 seconds to avoid flickering)
                if (now - this.lastProgressTime > 2000) {
                    const timeElapsed = (now - this.uploadStartTime) / 1000; // seconds
                    const uploadedMB = loaded / (1024 * 1024);
                    const totalMB = total / (1024 * 1024);
                    const remainingMB = totalMB - uploadedMB;
                    
                    // Calculate current speed (MB/s)
                    if (timeElapsed > 0) {
                        this.uploadSpeed = uploadedMB / timeElapsed;
                    }
                    
                    // Calculate ETA
                    let etaText = '';
                    if (this.uploadSpeed > 0 && remainingMB > 0) {
                        const etaSeconds = remainingMB / this.uploadSpeed;
                        etaText = this.formatTime(etaSeconds);
                    }
                    
                    // Update progress text with detailed information
                    if (progressTime) {
                        const elapsed = Math.floor(timeElapsed);
                        const speedText = this.uploadSpeed > 0 ? ` • ${this.uploadSpeed.toFixed(1)} MB/s` : '';
                        const etaDisplay = etaText ? ` • ETA: ${etaText}` : '';
                        
                        progressTime.innerHTML = `
                            <div class="flex justify-between text-xs">
                                <span>Uploaded: ${uploadedMB.toFixed(1)} / ${totalMB.toFixed(1)} MB</span>
                                <span>${percentage}%</span>
                            </div>
                            <div class="text-center mt-1">
                                Elapsed: ${elapsed}s${speedText}${etaDisplay}
                            </div>
                        `;
                    }
                    
                    this.lastProgressTime = now;
                }
            }
            
            // Helper function to parse file size string to bytes
            parseFileSizeToBytes(sizeString) {
                const match = sizeString.match(/^([\d.]+)\s*(MB|KB|GB)$/i);
                if (!match) return 0;
                
                const value = parseFloat(match[1]);
                const unit = match[2].toUpperCase();
                
                switch (unit) {
                    case 'KB':
                        return value * 1024;
                    case 'MB':
                        return value * 1024 * 1024;
                    case 'GB':
                        return value * 1024 * 1024 * 1024;
                    default:
                        return value;
                }
            }

            // Helper function to format time duration
            formatTime(seconds) {
                if (seconds < 60) {
                    return `${Math.round(seconds)}s`;
                } else if (seconds < 3600) {
                    const minutes = Math.floor(seconds / 60);
                    const secs = Math.round(seconds % 60);
                    return `${minutes}m ${secs}s`;
                } else {
                    const hours = Math.floor(seconds / 3600);
                    const minutes = Math.floor((seconds % 3600) / 60);
                    return `${hours}h ${minutes}m`;
                }
            }

            // Keep indeterminate progress for non-file uploads
            showIndeterminateProgress() {
                const progressBar = document.getElementById('progress-bar');
                const progressTime = document.getElementById('progress-time');
                
                if (progressBar) {
                    progressBar.style.width = '100%';
                    progressBar.className = 'progress-pulse h-3 rounded-full';
                }
                
                // For non-file uploads, show simpler progress info
                if (progressTime && this.startTime) {
                    const elapsed = Math.floor((Date.now() - this.startTime) / 1000);
                    progressTime.innerHTML = `
                        <div class="text-center">
                            Elapsed: ${elapsed}s
                        </div>
                    `;
                }
            }

            // Enhanced timer that differentiates between file and non-file uploads
            startTimer() {
                const progressTime = document.getElementById('progress-time');
                if (progressTime) {
                    this.progressTimer = setInterval(() => {
                        if (this.startTime && !this.totalFileSize) { // Non-file upload
                            const elapsed = Math.floor((Date.now() - this.startTime) / 1000);
                            progressTime.innerHTML = `<div class="text-center">Elapsed: ${elapsed}s</div>`;
                        }
                        // For file uploads, progress is updated in updateProgress()
                    }, 1000);
                }
            }
            
            cancelUpload() {
                if (this.isCancelling || this.cancelRequested) return;
                
                this.isCancelling = true;
                this.cancelRequested = true;
                
                console.log('Cancelling upload:', this.currentUploadId);
                
                // Update UI immediately
                const cancelButton = document.getElementById('cancel-upload-btn');
                if (cancelButton) {
                    cancelButton.disabled = true;
                    cancelButton.innerHTML = '<i class="ri-loader-line animate-spin mr-1"></i>Cancelling...';
                    cancelButton.className = 'w-full bg-gray-500 text-white px-4 py-2 rounded cursor-not-allowed text-sm';
                }
                
                document.getElementById('progress-title').textContent = 'Cancelling Upload...';
                document.getElementById('progress-message').textContent = 'Please wait while we stop the upload process...';
                
                // Show indeterminate progress during cancellation
                this.showIndeterminateProgress();
                
                // Cancel requests
                if (this.abortController) {
                    this.abortController.abort();
                }
                
                if (this.currentXHR) {
                    this.currentXHR.abort();
                }
                
                // Send cancellation to backend
                if (this.currentUploadId) {
                    fetch('/api/cancel-upload', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': this.getCsrfToken()
                        },
                        body: JSON.stringify({
                            upload_id: this.currentUploadId,
                            immediate: true
                        })
                    }).catch(error => {
                        console.log('Cancel request failed:', error);
                    });
                }
                
                this.isUploading = false;
                
                // Show cancellation result after a delay
                setTimeout(() => {
                    this.showResult('Upload cancelled by user', 'warning');
                }, 2000);
            }

            showResult(message, type) {
                const uploadResult = document.getElementById('upload-result');
                const resultContent = document.getElementById('upload-result-content');
                const actionButtons = document.getElementById('action-buttons');
                const progressSection = document.getElementById('progress-section');
                const resultActions = document.getElementById('result-actions');
                
                // Update result content
                const colors = {
                    success: 'bg-green-100 border border-green-400 text-green-700',
                    error: 'bg-red-100 border border-red-400 text-red-700',
                    warning: 'bg-yellow-100 border border-yellow-400 text-yellow-700'
                };
                
                const icons = {
                    success: 'ri-check-circle-line text-green-600',
                    error: 'ri-error-warning-line text-red-600',
                    warning: 'ri-alert-line text-yellow-600'
                };
                
                // Enhanced error message display
                let displayMessage = message;
                if (type === 'error' && message.includes('exceeds')) {
                    const maxSizeMB = Math.floor(this.maxFileSize / (1024 * 1024));
                    displayMessage = `
                        <div class="mb-2 font-medium">${message}</div>
                        <div class="text-sm">
                            <strong>What you can try:</strong>
                            <ul class="list-disc list-inside mt-1 space-y-1">
                                <li>Reduce the number of rows in your file</li>
                                <li>Remove unnecessary columns</li>
                                <li>Split the data into smaller files</li>
                                <li>Contact your administrator to request a higher limit</li>
                            </ul>
                        </div>
                    `;
                }
                
                resultContent.innerHTML = `
                    <div class="${colors[type]} rounded-lg p-4">
                        <div class="flex items-start">
                            <i class="${icons[type]} text-lg mr-2 mt-0.5 flex-shrink-0"></i>
                            <div class="flex-1">${displayMessage}</div>
                        </div>
                    </div>
                `;
                
                // Update icon and title
                const progressIcon = document.getElementById('progress-icon');
                const progressTitle = document.getElementById('progress-title');
                
                if (type === 'success') {
                    progressIcon.className = 'ri-check-circle-line text-5xl text-green-500';
                    progressTitle.textContent = 'Upload Complete!';
                } else if (type === 'error') {
                    progressIcon.className = 'ri-error-warning-line text-5xl text-red-500';
                    progressTitle.textContent = 'Upload Failed';
                } else {
                    progressIcon.className = 'ri-alert-line text-5xl text-yellow-500';
                    progressTitle.textContent = 'Upload Cancelled';
                }
                
                // Hide progress section and action buttons
                progressSection.classList.add('hidden');
                actionButtons.classList.add('hidden');
                
                // Show result and make close button visible
                uploadResult.classList.remove('hidden');
                resultActions.classList.remove('hidden');
            }

            // Modified upload methods to use enhanced progress
            async uploadFile(formElement) {
                const formData = new FormData(formElement);
                const fileInput = formElement.querySelector('input[type="file"]');
                const file = fileInput.files[0];
                
                if (!file) {
                    this.showMessage('Please select a file to upload', 'error');
                    return;
                }

                if (!this.validateFileType(file) || !this.validateFileSize(file)) {
                    return;
                }

                this.currentUploadId = this.generateUploadId('file');
                formData.append('upload_id', this.currentUploadId);

                // Show enhanced progress for files
                const fileSize = (file.size / 1024 / 1024).toFixed(1) + ' MB';
                this.showProgress('Uploading File', `Processing ${file.name}...`, 'file', file.name, fileSize);

                try {
                    const dbName = this.getDbNameFromUrl() || 'default';
                    const response = await this.sendAjaxRequest(`/ajax-upload-file/${dbName}`, formData);
                    this.handleUploadSuccess(response);
                } catch (error) {
                    this.handleUploadError(error);
                }
            }

            async uploadSheets(formElement) {
                const formData = new FormData(formElement);
                const sheetsUrl = formData.get('sheets_url');
                
                if (!sheetsUrl) {
                    this.showMessage('Please enter a Google Sheets URL', 'error');
                    return;
                }

                // Validate Google Sheets size limit
                if (!this.validateGoogleSheetsSize(sheetsUrl)) {
                    return;
                }

                // Ensure CSRF token is included
                const csrfToken = this.getCsrfToken();
                if (csrfToken) {
                    formData.set('csrftoken', csrfToken);
                }

                this.currentUploadId = this.generateUploadId('sheets');
                formData.append('upload_id', this.currentUploadId);

                this.showProgress('Importing Google Sheets', 'Fetching data from Google Sheets (first sheet only)...', 'sheets');
                this.showIndeterminateProgress();

                try {
                    const dbName = this.getDbNameFromUrl() || 'default';
                    const response = await this.sendAjaxRequest(`/ajax-upload-sheets/${dbName}`, formData);
                    this.handleUploadSuccess(response);
                } catch (error) {
                    this.handleUploadError(error);
                }
            }

            validateGoogleSheetsSize(url) {
                // Note: We can't pre-validate Google Sheets size without downloading,
                // but we inform user about the limit and handle it during processing
                const maxSizeMB = Math.floor(this.maxFileSize / (1024 * 1024));
                
                this.showMessage(
                    `Google Sheets Import Notice`,
                    'info',
                    `
                    <strong>Important:</strong>
                    <ul class="list-disc list-inside mt-1 space-y-1">
                        <li>Only the first sheet will be imported as a table</li>
                        <li>Maximum data size limit: ${maxSizeMB}MB</li>
                        <li>If your sheet exceeds this limit, the import will be cancelled</li>
                        <li>Large sheets may take several minutes to process</li>
                    </ul>
                    `
                );
                
                return true; // Continue with import
            }

            async uploadUrl(formElement) {
                const formData = new FormData(formElement);
                const csvUrl = formData.get('csv_url');
                
                if (!csvUrl) {
                    this.showMessage('Please enter a CSV URL', 'error');
                    return;
                }

                // Ensure CSRF token is included
                const csrfToken = this.getCsrfToken();
                if (csrfToken) {
                    formData.set('csrftoken', csrfToken);
                }

                this.currentUploadId = this.generateUploadId('url');
                formData.append('upload_id', this.currentUploadId);

                this.showProgress('Downloading CSV', 'Fetching data from URL...', 'url');
                this.showIndeterminateProgress();

                try {
                    const dbName = this.getDbNameFromUrl() || 'default';
                    const response = await this.sendAjaxRequest(`/ajax-upload-url/${dbName}`, formData);
                    this.handleUploadSuccess(response);
                } catch (error) {
                    this.handleUploadError(error);
                }
            }

            sendAjaxRequest(url, formData) {
                return new Promise((resolve, reject) => {
                    const xhr = new XMLHttpRequest();
                    this.currentXHR = xhr;

                    xhr.open('POST', url);
                    xhr.setRequestHeader('X-Requested-With', 'XMLHttpRequest');
                    
                    // Add CSRF token to headers if available
                    const csrfToken = this.getCsrfToken();
                    if (csrfToken) {
                        xhr.setRequestHeader('X-CSRFToken', csrfToken);
                    }

                    // Track upload progress
                    xhr.upload.addEventListener('progress', (e) => {
                        if (e.lengthComputable && !this.isCancelling) {
                            this.updateProgress(e.loaded, e.total);
                        }
                    });

                    xhr.addEventListener('load', () => {
                        if (xhr.status === 200) {
                            try {
                                const response = JSON.parse(xhr.responseText);
                                resolve(response);
                            } catch (e) {
                                reject(new Error('Invalid server response'));
                            }
                        } else if (xhr.status === 403) {
                            reject(new Error('Access denied. Please check your permissions or try refreshing the page.'));
                        } else if (xhr.status === 401) {
                            reject(new Error('Authentication required. Please log in again.'));
                        } else {
                            try {
                                const errorResponse = JSON.parse(xhr.responseText);
                                reject(new Error(errorResponse.error || `HTTP ${xhr.status}: ${xhr.statusText}`));
                            } catch (parseError) {
                                reject(new Error(`HTTP ${xhr.status}: ${xhr.statusText}`));
                            }
                        }
                    });

                    xhr.addEventListener('error', () => {
                        reject(new Error('Network error occurred'));
                    });

                    xhr.addEventListener('abort', () => {
                        reject(new Error('Upload cancelled'));
                    });

                    xhr.send(formData);
                });
            }

            handleUploadSuccess(response) {
                if (response.success) {
                    this.showResult(response.message, 'success');
                    
                    // Redirect after delay
                    setTimeout(() => {
                        this.hideProgress();
                        window.location.href = response.redirect_url || '/manage-databases';
                    }, 3000);
                } else {
                    this.handleUploadError(new Error(response.error));
                }
            }

            handleUploadError(error) {
                console.error('Upload error:', error);
                
                let errorMessage = 'Upload failed';
                let errorType = 'error';
                
                if (error.message) {
                    const msg = error.message.toLowerCase();
                    
                    // Match backend error categorization
                    if (msg.includes('too large') || msg.includes('size') || msg.includes('exceeded') || msg.includes('limit')) {
                        errorMessage = error.message;
                        errorType = 'error';
                    } else if (msg.includes('cancelled')) {
                        errorMessage = 'Upload was cancelled by user';
                        errorType = 'warning';
                    } else if (msg.includes('access denied') || msg.includes('permission')) {
                        errorMessage = 'Access denied. Please refresh the page and try again.';
                        errorType = 'error';
                    } else if (msg.includes('authentication') || msg.includes('session')) {
                        errorMessage = 'Session expired. Please refresh the page and log in again.';
                        errorType = 'error';
                    } else if (msg.includes('network') || msg.includes('connection')) {
                        errorMessage = 'Network connection failed. Please check your internet connection and try again.';
                        errorType = 'error';
                    } else if (msg.includes('format') || msg.includes('csv') || msg.includes('excel') || msg.includes('invalid')) {
                        errorMessage = error.message; // Use backend's detailed format error
                        errorType = 'error';
                    } else {
                        errorMessage = error.message;
                        errorType = 'error';
                    }
                }
                
                this.showResult(errorMessage, errorType);
                this.isUploading = false;
                this.currentUploadId = null;
            }

            showCleanupProcess(errorMessage) {
                // Update UI to show cleanup in progress
                document.getElementById('progress-title').textContent = 'Cleaning Up...';
                document.getElementById('progress-message').textContent = 'Stopping upload and cleaning temporary files...';
                
                // Show indeterminate progress
                this.showIndeterminateProgress();
                
                // Hide cancel button during cleanup
                const cancelButton = document.getElementById('cancel-upload-btn');
                const resultActions = document.getElementById('result-actions');
                
                if (cancelButton) {
                    cancelButton.classList.add('hidden');
                }
                
                // Hide close button during cleanup
                if (resultActions) {
                    resultActions.classList.add('hidden');
                }
                
                // Show cleanup progress for 2-3 seconds, then show final result
                setTimeout(() => {
                    // Re-enable close button after cleanup
                    if (resultActions) {
                        resultActions.classList.remove('hidden');
                    }
                    this.showResult(errorMessage, 'error');
                }, 2500);
            }
        }
        // Initialize upload manager
        const uploadManager = new EnhancedUploadManager();

        // File handling functions
        function handleFileSelect(input) {
            const file = input.files[0];
            const uploadBtn = document.getElementById('file-upload-btn');
            const uploadText = document.getElementById('file-upload-text');
            const fileInfo = document.getElementById('file-info');
            const fileDetails = document.getElementById('file-details');
            const fileWarnings = document.getElementById('file-warnings');
            const fileErrors = document.getElementById('file-errors');
            
            // Clear previous states
            fileWarnings.classList.add('hidden');
            fileErrors.classList.add('hidden');
            uploadManager.clearAllMessages();

            if (file) {
                console.log('Selected file:', file.name, 'Size:', file.size, 'Type:', file.type);
                
                // Validate file - this will show user-friendly error messages
                const isValidType = uploadManager.validateFileType(file);
                const isValidSize = uploadManager.validateFileSize(file);
                
                if (!isValidType || !isValidSize) {
                    uploadBtn.disabled = true;
                    uploadText.textContent = 'Invalid file selected';
                    fileInfo.classList.add('hidden');
                    return;
                }

                // Show file details
                const sizeInMB = (file.size / 1024 / 1024).toFixed(2);
                const fileType = file.name.split('.').pop().toUpperCase();
                const extension = '.' + file.name.split('.').pop().toLowerCase();
                
                fileDetails.innerHTML = `
                    <div class="flex items-center">
                        <i class="ri-file-line text-blue-600 mr-2"></i>
                        <div>
                            <div class="font-medium">${file.name}</div>
                            <div class="text-sm text-gray-600">${sizeInMB} MB • ${fileType} file</div>
                        </div>
                    </div>
                `;
                
                fileInfo.classList.remove('hidden');
                
                // Show warnings for large files
                if (file.size > 50 * 1024 * 1024) { // 50MB
                    fileWarnings.classList.remove('hidden');
                    fileWarnings.querySelector('div').innerHTML = `
                        <i class="ri-alert-line mr-1"></i>
                        <strong>Large file detected:</strong> Upload may take several minutes to complete.
                    `;
                }
                // FIX: Moved extension-based warnings to separate condition and defined extension variable
                else if (['.xlsx', '.xls'].includes(extension)) {
                    fileWarnings.classList.remove('hidden');
                    fileWarnings.querySelector('div').innerHTML = `
                        <i class="ri-information-line mr-1"></i>
                        <strong>Excel file:</strong> Only the first sheet will be imported. For multiple sheets, save each as a separate CSV file.
                    `;
                } else if (['.jsonl', '.json'].includes(extension)) {
                    fileWarnings.classList.remove('hidden');
                    fileWarnings.querySelector('div').innerHTML = `
                        <i class="ri-information-line mr-1"></i>
                        <strong>JSON file:</strong> Expected format is one JSON object per line (JSONL). Regular JSON arrays will be processed if possible.
                    `;
                }
                
                // Enable upload button
                uploadBtn.disabled = false;
                uploadText.textContent = 'Upload File';
                
                // Auto-generate table name if not set
                const tableNameInput = document.getElementById('table-name');
                if (!tableNameInput.value) {
                    const baseName = file.name.replace(/\.[^/.]+$/, "").replace(/[^a-zA-Z0-9_]/g, '_').toLowerCase();
                    tableNameInput.value = baseName;
                }
            } else {
                fileInfo.classList.add('hidden');
                uploadBtn.disabled = true;
                uploadText.textContent = 'Select a file to upload';
            }
        }

        function handleDragOver(event) {
            event.preventDefault();
            event.currentTarget.classList.add('border-blue-400', 'bg-blue-50');
        }

        function handleDrop(event) {
            event.preventDefault();
            const dropZone = event.currentTarget;
            dropZone.classList.remove('border-blue-400', 'bg-blue-50');
            
            const files = event.dataTransfer.files;
            if (files.length > 0) {
                document.getElementById('file-input').files = files;
                handleFileSelect(document.getElementById('file-input'));
            }
        }

        function handleDragLeave(event) {
            event.preventDefault();
            event.currentTarget.classList.remove('border-blue-400', 'bg-blue-50');
        }

        function validateSheetsUrl() {
            const urlInput = document.getElementById('sheets-url');
            const validation = document.getElementById('sheets-validation');
            const content = document.getElementById('sheets-validation-content');
            const url = urlInput.value.trim();
            
            if (!url) {
                validation.classList.add('hidden');
                return;
            }
            
            if (url.includes('docs.google.com/spreadsheets/')) {
                content.innerHTML = `
                    <div class="text-green-700 bg-green-50 border-green-200">
                        <i class="ri-check-line mr-1"></i>
                        <strong>Valid Google Sheets URL</strong> - Ready to import
                    </div>
                `;
                content.className = 'p-3 rounded border bg-green-50 border-green-200 text-green-700';
            } else {
                content.innerHTML = `
                    <div class="text-red-700">
                        <i class="ri-error-warning-line mr-1"></i>
                        <strong>Invalid URL format</strong> - Please use a Google Sheets sharing URL
                    </div>
                `;
                content.className = 'p-3 rounded border bg-red-50 border-red-200 text-red-700';
            }
            
            validation.classList.remove('hidden');
        }

        function validateCsvUrl() {
            const urlInput = document.getElementById('csv-url');
            const validation = document.getElementById('url-validation');
            const content = document.getElementById('url-validation-content');
            const url = urlInput.value.trim();
            
            if (!url) {
                validation.classList.add('hidden');
                return;
            }
            
            try {
                const urlObj = new URL(url);
                const isCSV = url.toLowerCase().includes('.csv');
                
                if (isCSV) {
                    content.innerHTML = `
                        <div class="text-blue-700">
                            <i class="ri-check-line mr-1"></i>
                            <strong>Valid CSV URL</strong> - Domain: ${urlObj.hostname}
                        </div>
                    `;
                    content.className = 'p-3 rounded border bg-blue-50 border-blue-200 text-blue-700';
                } else {
                    content.innerHTML = `
                        <div class="text-yellow-700">
                            <i class="ri-information-line mr-1"></i>
                            <strong>Note:</strong> URL should point to a .csv file for best results
                        </div>
                    `;
                    content.className = 'p-3 rounded border bg-yellow-50 border-yellow-200 text-yellow-700';
                }
            } catch (e) {
                content.innerHTML = `
                    <div class="text-red-700">
                        <i class="ri-error-warning-line mr-1"></i>
                        <strong>Invalid URL format</strong> - Please enter a valid URL
                    </div>
                `;
                content.className = 'p-3 rounded border bg-red-50 border-red-200 text-red-700';
            }
            
            validation.classList.remove('hidden');
        }

        // Tab management
        function switchUploadTab(tabName) {
            // Clear any existing messages when switching tabs
            uploadManager.clearAllMessages();
            
            // Hide all panels
            const panels = document.querySelectorAll('.upload-panel');
            panels.forEach(panel => panel.classList.add('hidden'));
            
            // Reset all tabs
            const tabs = document.querySelectorAll('.upload-tab');
            tabs.forEach(tab => {
                tab.classList.remove('active', 'text-blue-600', 'border-blue-600');
                tab.classList.add('text-gray-500');
            });
            
            // Show selected panel
            document.getElementById(tabName + '-panel').classList.remove('hidden');
            
            // Activate selected tab
            const activeTab = document.getElementById(tabName + '-tab');
            activeTab.classList.add('active', 'text-blue-600', 'border-blue-600');
            activeTab.classList.remove('text-gray-500');
            
            // Clear validation displays
            const validations = ['sheets-validation', 'url-validation'];
            validations.forEach(id => {
                const element = document.getElementById(id);
                if (element) element.classList.add('hidden');
            });
        }

        // Form handlers
        function handleFileUpload(event) {
            event.preventDefault();
            uploadManager.uploadFile(event.target);
            return false;
        }

        function handleSheetsUpload(event) {
            event.preventDefault();
            uploadManager.uploadSheets(event.target);
            return false;
        }

        function handleUrlUpload(event) {
            event.preventDefault();
            uploadManager.uploadUrl(event.target);
            return false;
        }

        // Event listeners
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize default tab
            switchUploadTab('file');
            
            // Cancel button handler
            document.getElementById('cancel-upload-btn').addEventListener('click', function(event) {
                event.preventDefault();
                uploadManager.cancelUpload();
            });
            
            // Close result button handler
            document.getElementById('close-result-btn').addEventListener('click', function() {
                uploadManager.hideProgress();
            });
            
            // ESC key support
            document.addEventListener('keydown', function(event) {
                if (event.key === 'Escape' && uploadManager.isUploading && !uploadManager.isCancelling) {
                    uploadManager.cancelUpload();
                }
            });
            
            // Prevent page unload during upload
            window.addEventListener('beforeunload', function(event) {
                if (uploadManager.isUploading && !uploadManager.isCancelling) {
                    event.preventDefault();
                    event.returnValue = 'Upload in progress. Are you sure you want to leave?';
                    return 'Upload in progress. Are you sure you want to leave?';
                }
            });
        });
    </script>
</body>
</html>